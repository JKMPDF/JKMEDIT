<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Asset Manager</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- Apple/Professional Theme Variables --- */
        :root {
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --primary-color: #007aff; /* Apple Blue */
            --danger-color: #ff3b30;  /* Apple Red */
            --text-color: #1d1d1f;
            --sub-text: #86868b;
            --border-radius: 12px;
            --input-bg: #eef0f2;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); 
            color: var(--text-color);
            margin: 0;
            padding: 20px 10px;
            -webkit-font-smoothing: antialiased;
        }

        .container { 
            max-width: 600px; 
            margin: 0 auto; 
        }
        
        h1 { 
            text-align: center; 
            font-weight: 700; 
            font-size: 1.5rem; 
            margin-bottom: 20px; 
            color: #000;
        }

        /* --- Cards --- */
        .card { 
            background: var(--card-bg); 
            border-radius: var(--border-radius); 
            padding: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
        }

        /* --- Inputs & Labels --- */
        label { 
            font-size: 0.85rem; 
            font-weight: 600; 
            color: var(--sub-text); 
            margin-bottom: 6px; 
            display: block; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"], select { 
            width: 100%; 
            padding: 12px 14px; 
            border: none;
            background: var(--input-bg);
            border-radius: 8px; 
            font-size: 16px; /* Prevents zoom on iOS */
            color: var(--text-color);
            box-sizing: border-box; 
            margin-bottom: 15px;
            outline: none;
            transition: background 0.2s;
        }
        input[type="text"]:focus, select:focus {
            background: #e0e0e0;
        }

        /* --- Buttons --- */
        .btn { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.7; }
        
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: #34c759; color: white; margin-top: 5px; } /* Apple Green */
        .btn-danger { background-color: var(--input-bg); color: var(--danger-color); font-weight: 500;} /* Ghost button style */
        .btn-outline { background-color: var(--input-bg); color: var(--primary-color); }

        /* --- Row for Dropdown + Buttons --- */
        .input-row { display: flex; gap: 10px; align-items: flex-start; }
        .input-row select { flex: 1; }
        
        .btn-icon { 
            width: 46px; 
            height: 43px; 
            padding: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 20px; 
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--primary-color);
            border: none;
            cursor: pointer;
        }
        
        /* Specific style for delete category button */
        .btn-icon.delete-cat {
            color: var(--danger-color);
            font-size: 18px;
        }

        /* --- Scanner --- */
        #reader { 
            width: 100%; 
            border-radius: 10px; 
            overflow: hidden; 
            background: black;
            margin-bottom: 15px;
        }
        
        /* --- Modal (Popup) --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal {
            background: white;
            padding: 25px;
            border-radius: 16px;
            width: 85%;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal h3 { margin-top: 0; margin-bottom: 15px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 10px; }

        /* --- Grouped Tables --- */
        .group-header { 
            font-size: 1.1rem; 
            font-weight: 700; 
            margin: 25px 0 10px 5px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .badge {
            background: #e5e5ea; 
            color: #8e8e93; 
            font-size: 0.8rem; 
            padding: 2px 8px; 
            border-radius: 6px;
        }

        .data-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            table-layout: fixed;
        }
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.95rem;
            vertical-align: top;
            word-wrap: break-word;
        }
        .data-table tr:last-child td { border-bottom: none; }
        
        .timestamp-col { color: var(--sub-text); font-size: 0.8rem; width: 75px; }
        .action-col { width: 40px; text-align: right; vertical-align: middle !important; }

        /* Delete row button */
        .btn-delete-row {
            background: transparent;
            border: none;
            color: #c7c7cc;
            font-size: 20px;
            line-height: 1;
            padding: 5px;
            cursor: pointer;
        }
        .btn-delete-row:hover { color: var(--danger-color); }

        .footer-controls { margin-top: 40px; display: flex; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Inventory Scan</h1>

    <div class="card">
        <div id="reader"></div>
        <button id="start-scan-btn" class="btn btn-primary">Start Camera</button>
    </div>

    <div class="card">
        <label>Scanned Data</label>
        <input type="text" id="qr-data" placeholder="Scan a QR code..." readonly>

        <label>Select Item Category</label>
        <div class="input-row">
            <select id="item-select">
                <option value="" disabled selected>Select Category</option>
            </select>
            <button onclick="deleteCurrentCategory()" class="btn-icon delete-cat" title="Delete Selected Category">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
            <button onclick="openModal()" class="btn-icon" title="Add New Category">+</button>
        </div>

        <button onclick="saveEntry()" class="btn btn-success">Save Entry</button>
    </div>

    <div id="grouped-data-area">
        </div>

    <div class="footer-controls">
        <button onclick="downloadExcel()" class="btn btn-outline">Export to Excel</button>
        <button onclick="clearAllData()" class="btn btn-danger">Clear All History</button>
    </div>
</div>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal">
        <h3>Add Category</h3>
        <input type="text" id="new-category-input" placeholder="E.g. Box A, Shelf 1..." autofocus>
        <div class="modal-buttons">
            <button onclick="closeModal()" class="btn" style="background:#e5e5ea; color:#333;">Cancel</button>
            <button onclick="addNewItem()" class="btn btn-primary">Add</button>
        </div>
    </div>
</div>

<script>
    /* --- CONFIG --- */
    const KEY_ENTRIES = 'qr_pro_entries';
    const KEY_ITEMS = 'qr_pro_items';
    
    let html5QrcodeScanner = null;
    let savedEntries = JSON.parse(localStorage.getItem(KEY_ENTRIES)) || [];
    let availableItems = JSON.parse(localStorage.getItem(KEY_ITEMS)) || [];

    /* --- INITIALIZATION --- */
    window.onload = function() {
        updateDropdown();
        renderGroupedData();
    };

    /* --- MODAL LOGIC --- */
    const modal = document.getElementById('modal-overlay');
    const modalInput = document.getElementById('new-category-input');

    function openModal() {
        modal.style.display = 'flex';
        modalInput.focus();
    }

    function closeModal() {
        modal.style.display = 'none';
        modalInput.value = '';
    }

    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });

    /* --- CATEGORY MANAGEMENT --- */
    function addNewItem() {
        const itemName = modalInput.value.trim();

        if (!itemName) {
            alert("Please enter a name.");
            return;
        }
        if (availableItems.includes(itemName)) {
            alert("This category already exists.");
            return;
        }

        availableItems.push(itemName);
        localStorage.setItem(KEY_ITEMS, JSON.stringify(availableItems));
        
        updateDropdown();
        closeModal();
        
        // Auto-select the newly created item
        document.getElementById('item-select').value = itemName;
    }

    function deleteCurrentCategory() {
        const select = document.getElementById('item-select');
        const categoryToDelete = select.value;

        if (!categoryToDelete) {
            alert("Please select a category to delete.");
            return;
        }

        // CONSTRAINT CHECK: Is this category used in any saved entry?
        const isUsed = savedEntries.some(entry => entry.item === categoryToDelete);

        if (isUsed) {
            alert(`Cannot delete "${categoryToDelete}" because it contains saved entries. \n\nPlease delete the entries associated with this category first.`);
            return;
        }

        if (confirm(`Are you sure you want to delete the category "${categoryToDelete}"?`)) {
            // Remove from array
            availableItems = availableItems.filter(item => item !== categoryToDelete);
            localStorage.setItem(KEY_ITEMS, JSON.stringify(availableItems));
            
            updateDropdown();
            // Reset selection
            select.value = "";
        }
    }

    function updateDropdown() {
        const select = document.getElementById('item-select');
        const currentVal = select.value;
        
        select.innerHTML = '<option value="" disabled selected>Select Category</option>';
        
        availableItems.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            select.appendChild(option);
        });

        // Restore selection if it still exists
        if (availableItems.includes(currentVal)) {
            select.value = currentVal;
        }
    }

    /* --- SCANNER LOGIC --- */
    const startBtn = document.getElementById('start-scan-btn');
    
    startBtn.addEventListener('click', () => {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
                startBtn.textContent = "Start Camera";
                startBtn.classList.remove('btn-danger');
                startBtn.classList.add('btn-primary');
            }).catch(err => console.error(err));
            return;
        }

        html5QrcodeScanner = new Html5Qrcode("reader");
        const qrBoxSize = Math.min(250, window.innerWidth - 60);

        html5QrcodeScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: qrBoxSize, height: qrBoxSize } },
            (decodedText) => {
                document.getElementById('qr-data').value = decodedText;
                if(navigator.vibrate) navigator.vibrate(50);
            },
            (error) => { }
        ).then(() => {
            startBtn.textContent = "Stop Camera";
            startBtn.classList.remove('btn-primary');
            startBtn.classList.add('btn-danger'); // Red when active
        });
    });

    /* --- ENTRY MANAGEMENT --- */
    function saveEntry() {
        const qrInput = document.getElementById('qr-data');
        const itemSelect = document.getElementById('item-select');
        
        const qrData = qrInput.value;
        const itemType = itemSelect.value;

        if (!qrData) {
            alert("Please scan a code first.");
            return;
        }
        if (!itemType) {
            alert("Please select a category.");
            return;
        }

        const newEntry = {
            id: Date.now(),
            timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            fullTime: new Date().toLocaleString(),
            qr: qrData,
            item: itemType
        };

        savedEntries.push(newEntry);
        localStorage.setItem(KEY_ENTRIES, JSON.stringify(savedEntries));

        renderGroupedData();
        
        // --- RESET FIELDS ---
        qrInput.value = '';        // Clear QR
        itemSelect.value = "";     // Reset Category to default (Select Category)
    }

    function deleteEntry(id) {
        if (confirm("Delete this entry?")) {
            savedEntries = savedEntries.filter(entry => entry.id !== id);
            localStorage.setItem(KEY_ENTRIES, JSON.stringify(savedEntries));
            renderGroupedData();
        }
    }

    /* --- RENDER DATA LOGIC --- */
    function renderGroupedData() {
        const container = document.getElementById('grouped-data-area');
        container.innerHTML = '';

        if (savedEntries.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #86868b; margin-top: 30px;">No scans recorded yet.</p>';
            return;
        }

        // Loop through available items to maintain order, plus handle orphans
        const uniqueItems = [...new Set([...availableItems, ...savedEntries.map(e=>e.item)])];

        uniqueItems.forEach(item => {
            const itemEntries = savedEntries.filter(entry => entry.item === item);
            
            if (itemEntries.length > 0) {
                // Header
                const header = document.createElement('div');
                header.className = 'group-header';
                header.innerHTML = `${item} <span class="badge">${itemEntries.length}</span>`;
                container.appendChild(header);

                // Table
                const table = document.createElement('table');
                table.className = 'data-table';
                
                // Reverse to show newest on top
                const rows = itemEntries.slice().reverse().map(e => `
                    <tr>
                        <td class="timestamp-col">${e.timestamp}</td>
                        <td>${e.qr}</td>
                        <td class="action-col">
                            <button onclick="deleteEntry(${e.id})" class="btn-delete-row" title="Delete Entry">&times;</button>
                        </td>
                    </tr>
                `).join('');
                
                table.innerHTML = `<tbody>${rows}</tbody>`;
                container.appendChild(table);
            }
        });
    }

    /* --- EXPORT/CLEAR LOGIC --- */
    function downloadExcel() {
        if (savedEntries.length === 0) {
            alert("No data to export.");
            return;
        }

        const sorted = savedEntries.slice().sort((a, b) => a.item.localeCompare(b.item));
        let csv = "data:text/csv;charset=utf-8,Category,Date Time,QR Content\n";
        
        sorted.forEach(e => {
            const safeQr = e.qr.replace(/"/g, '""');
            const safeItem = e.item.replace(/"/g, '""');
            csv += `"${safeItem}","${e.fullTime}","${safeQr}"\n`;
        });

        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = "inventory_scan.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function clearAllData() {
        if (confirm("Delete ALL history and categories? This cannot be undone.")) {
            localStorage.removeItem(KEY_ENTRIES);
            localStorage.removeItem(KEY_ITEMS);
            savedEntries = [];
            availableItems = [];
            updateDropdown();
            renderGroupedData();
        }
    }
</script>

</body>
</html>
