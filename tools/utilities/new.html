<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner & Grouped Inventory</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        h2, h3 { color: #333; }
        h2 { text-align: center; }

        /* Sections */
        .section-box { padding: 15px; background: #e9ecef; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        
        /* Inputs & Buttons */
        label { font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; width: 100%; box-sizing: border-box; margin-bottom: 10px;}
        
        .btn { padding: 10px 15px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; color: white; display: inline-block; }
        .btn-primary { background-color: #007bff; width: 100%; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-add { background-color: #17a2b8; width: auto; margin-top: 5px;}
        .btn-success { background-color: #28a745; width: 100%; }
        .btn-danger { background-color: #dc3545; }
        
        /* Flex row for add item */
        .add-item-row { display: flex; gap: 10px; }
        .add-item-row input { margin-bottom: 0; }

        /* Scanner */
        #reader { width: 100%; min-height: 300px; background: #000; margin-bottom: 10px; border-radius: 4px; }
        #scan-status { text-align: center; margin-bottom: 10px; font-weight: bold; color: #555; }

        /* Grouped Tables */
        .group-container { margin-bottom: 30px; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        .group-header { background-color: #333; color: white; padding: 10px 15px; font-size: 1.1em; display: flex; justify-content: space-between; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #ddd; padding: 10px; text-align: left; }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        th { background-color: #eee; font-size: 0.85em; text-transform: uppercase; color: #555; }

        .controls { display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <h2>QR Inventory Manager</h2>

    <div class="section-box">
        <h3>1. Create Item List</h3>
        <label>Add new item to list:</label>
        <div class="add-item-row">
            <input type="text" id="new-item-name" placeholder="E.g., Laptop, Chair, Box A...">
            <button onclick="addNewItem()" class="btn btn-add">Add Item</button>
        </div>
        <p style="font-size: 0.8em; color: #666; margin-top: 5px;">Currently available items: <span id="item-count">0</span></p>
    </div>

    <div class="section-box">
        <h3>2. Scan & Save</h3>
        <div id="reader"></div>
        <div id="scan-status">Camera is off</div>
        <button id="start-scan-btn" class="btn btn-primary">Start Scanning</button>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ccc;">

        <label>Scanned QR Data:</label>
        <input type="text" id="qr-data" placeholder="Scan result will appear here..." readonly>
        
        <label>Assign to Item:</label>
        <select id="item-select">
            <option value="" disabled selected>-- Create an item above first --</option>
        </select>
        
        <button onclick="saveEntry()" class="btn btn-success" style="margin-top: 10px;">Save Entry</button>
    </div>

    <h3>Saved Data (Grouped)</h3>
    <div id="grouped-data-area">
        <p style="text-align: center; color: #777;">No data saved yet.</p>
    </div>

    <div class="controls">
        <button onclick="downloadExcel()" class="btn btn-primary" style="width: auto;">Download Excel</button>
        <button onclick="clearAllData()" class="btn btn-danger" style="width: auto;">Clear History & Items</button>
    </div>
</div>

<script>
    // --- Configuration ---
    const KEY_ENTRIES = 'qr_grouped_entries'; // Stores scans
    const KEY_ITEMS = 'qr_grouped_items';     // Stores the list of items user created
    
    let html5QrcodeScanner = null;
    
    // Load data from storage or initialize empty
    let savedEntries = JSON.parse(localStorage.getItem(KEY_ENTRIES)) || [];
    let availableItems = JSON.parse(localStorage.getItem(KEY_ITEMS)) || [];

    // --- Initialization ---
    window.onload = function() {
        updateDropdown();
        renderGroupedData();
    };

    // --- 1. Item Management Logic ---
    function addNewItem() {
        const input = document.getElementById('new-item-name');
        const itemName = input.value.trim();

        if (!itemName) {
            alert("Please enter an item name.");
            return;
        }

        // Check for duplicates
        if (availableItems.includes(itemName)) {
            alert("This item already exists in your list.");
            return;
        }

        // Add, Save, Update UI
        availableItems.push(itemName);
        localStorage.setItem(KEY_ITEMS, JSON.stringify(availableItems));
        
        input.value = ''; // Clear input
        updateDropdown();
    }

    function updateDropdown() {
        const select = document.getElementById('item-select');
        const countSpan = document.getElementById('item-count');
        
        select.innerHTML = '<option value="" disabled selected>-- Select an Item --</option>';
        
        availableItems.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            select.appendChild(option);
        });

        countSpan.textContent = availableItems.length;
    }

    // --- 2. Scanning Logic ---
    const startBtn = document.getElementById('start-scan-btn');
    
    startBtn.addEventListener('click', () => {
        const statusText = document.getElementById('scan-status');
        
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
                startBtn.textContent = "Start Scanning";
                statusText.textContent = "Camera is off";
            }).catch(err => console.error(err));
            return;
        }

        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText) => {
                document.getElementById('qr-data').value = decodedText;
                // Optional: Beep or small vibration here
                if(navigator.vibrate) navigator.vibrate(200);
            },
            (error) => { /* ignore failures */ }
        ).then(() => {
            startBtn.textContent = "Stop Camera";
            statusText.textContent = "Scanning...";
        });
    });

    // --- 3. Save Entry Logic ---
    function saveEntry() {
        const qrData = document.getElementById('qr-data').value;
        const itemType = document.getElementById('item-select').value;

        if (!qrData) {
            alert("No QR data found. Please scan first.");
            return;
        }
        if (!itemType) {
            alert("Please select an item from the list.");
            return;
        }

        const newEntry = {
            id: Date.now(), // Unique ID
            timestamp: new Date().toLocaleString(),
            qr: qrData,
            item: itemType
        };

        savedEntries.push(newEntry);
        localStorage.setItem(KEY_ENTRIES, JSON.stringify(savedEntries));

        renderGroupedData();
        document.getElementById('qr-data').value = ''; // Clear QR input only, keep item selected? 
        // Or clear both. Let's clear QR only to allow rapid scanning of same item type.
    }

    // --- 4. Grouped Rendering Logic ---
    function renderGroupedData() {
        const container = document.getElementById('grouped-data-area');
        container.innerHTML = '';

        if (savedEntries.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #777;">No data saved yet.</p>';
            return;
        }

        // Get list of items that actually have data + available items (merged unique)
        // We iterate through 'availableItems' to control the order.
        // If there are 'orphaned' entries (item deleted but scan remains), we can handle them too.
        
        let activeGroups = 0;

        availableItems.forEach(item => {
            // Filter entries for this specific item
            const itemEntries = savedEntries.filter(entry => entry.item === item);

            if (itemEntries.length > 0) {
                activeGroups++;
                // Create Group Container
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group-container';

                // Header
                const header = document.createElement('div');
                header.className = 'group-header';
                header.innerHTML = `<span>${item}</span> <span>Count: ${itemEntries.length}</span>`;
                groupDiv.appendChild(header);

                // Table
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th width="30%">Time</th>
                            <th width="70%">QR Content</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemEntries.map(e => `
                            <tr>
                                <td>${e.timestamp}</td>
                                <td>${e.qr}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                groupDiv.appendChild(table);
                container.appendChild(groupDiv);
            }
        });

        // Handle Orphaned Data (Optional: if you scanned something then deleted the item category)
        const orphanedEntries = savedEntries.filter(entry => !availableItems.includes(entry.item));
        if (orphanedEntries.length > 0) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group-container';
            groupDiv.innerHTML = `
                <div class="group-header" style="background:#555;">
                    <span>Uncategorized / Deleted Items</span> 
                    <span>Count: ${orphanedEntries.length}</span>
                </div>
                <table>
                    <thead><tr><th>Time</th><th>Item Name</th><th>QR Content</th></tr></thead>
                    <tbody>
                        ${orphanedEntries.map(e => `<tr><td>${e.timestamp}</td><td>${e.item}</td><td>${e.qr}</td></tr>`).join('')}
                    </tbody>
                </table>
            `;
            container.appendChild(groupDiv);
        }
    }

    // --- 5. Export Logic (Sorted by Group) ---
    function downloadExcel() {
        if (savedEntries.length === 0) {
            alert("No data to download.");
            return;
        }

        // Sort entries by Item Name, then by Timestamp
        const sortedEntries = savedEntries.slice().sort((a, b) => {
            if (a.item < b.item) return -1;
            if (a.item > b.item) return 1;
            return 0;
        });

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Item Category,Time,QR Data\n";

        sortedEntries.forEach(e => {
            // Escape quotes to prevent CSV errors
            const safeQr = e.qr.replace(/"/g, '""'); 
            const safeItem = e.item.replace(/"/g, '""');
            csvContent += `"${safeItem}","${e.timestamp}","${safeQr}"\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "grouped_inventory.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- 6. Clear Data ---
    function clearAllData() {
        if (confirm("DANGER: This will delete ALL saved scans AND your Item List. Are you sure?")) {
            savedEntries = [];
            availableItems = [];
            localStorage.removeItem(KEY_ENTRIES);
            localStorage.removeItem(KEY_ITEMS);
            updateDropdown();
            renderGroupedData();
        }
    }
</script>

</body>
</html>
