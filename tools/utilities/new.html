<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner & Inventory Logger</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        h2 { text-align: center; color: #333; }
        
        /* Scanner Section */
        #reader { width: 100%; min-height: 300px; background: #eee; margin-bottom: 20px; border-radius: 4px; }
        
        /* Input Section */
        .input-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; padding: 15px; background: #e9ecef; border-radius: 8px; }
        label { font-weight: bold; font-size: 0.9em; }
        input, select, button { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        
        /* Buttons */
        .btn-primary { background-color: #007bff; color: white; border: none; cursor: pointer; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; color: white; border: none; cursor: pointer; }
        .btn-danger { background-color: #dc3545; color: white; border: none; cursor: pointer; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #333; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        
        .controls { display: flex; justify-content: space-between; margin-top: 20px; }
        
        #scan-status { text-align: center; margin-bottom: 10px; font-weight: bold; color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h2>QR Logger & Excel Export</h2>

    <div id="reader"></div>
    <div id="scan-status">Camera is off</div>
    <button id="start-scan-btn" class="btn-primary" style="width:100%; margin-bottom:10px;">Start Scanning</button>

    <div class="input-group">
        <label>Scanned Data:</label>
        <input type="text" id="qr-data" placeholder="Scan a QR code or type here..." readonly>
        
        <label>Select Item Type:</label>
        <select id="item-select">
            <option value="" disabled selected>-- Select an Item --</option>
            <option value="Inventory Item A">Inventory Item A</option>
            <option value="Inventory Item B">Inventory Item B</option>
            <option value="Warehouse Section 1">Warehouse Section 1</option>
            <option value="Employee ID">Employee ID</option>
            <option value="General Asset">General Asset</option>
        </select>
        
        <button onclick="saveEntry()" class="btn-success">Save Entry</button>
    </div>

    <hr>

    <h3>Saved Entries</h3>
    <table id="data-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>QR Data</th>
                <th>Selected Item</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div class="controls">
        <button onclick="downloadExcel()" class="btn-primary">Download Excel</button>
        <button onclick="clearAllData()" class="btn-danger">Clear All Data</button>
    </div>
</div>

<script>
    // --- 1. Variables and Setup ---
    const STORAGE_KEY = 'qr_scanner_entries';
    let html5QrcodeScanner = null;
    let savedEntries = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    // --- 2. Initialize Page ---
    window.onload = function() {
        renderTable();
    };

    // --- 3. Scanning Logic ---
    const startBtn = document.getElementById('start-scan-btn');
    
    startBtn.addEventListener('click', () => {
        const statusText = document.getElementById('scan-status');
        
        // If scanner is already running, stop it (Toggle functionality)
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
                startBtn.textContent = "Start Scanning";
                statusText.textContent = "Camera is off";
            }).catch(err => console.error(err));
            return;
        }

        // Start Scanner
        html5QrcodeScanner = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        html5QrcodeScanner.start(
            { facingMode: "environment" }, // Use back camera
            config,
            onScanSuccess,
            onScanFailure
        ).then(() => {
            startBtn.textContent = "Stop Camera";
            statusText.textContent = "Scanning...";
        });
    });

    function onScanSuccess(decodedText, decodedResult) {
        // Play a beep or visual cue here if desired
        document.getElementById('qr-data').value = decodedText;
        
        // Optional: Stop scanning after one successful scan to let user save
        // html5QrcodeScanner.stop().then(...); 
        // For now, we keep it running or let the user stop it manually, 
        // but we give visual feedback that data was captured.
        alert("QR Code Detected: " + decodedText);
    }

    function onScanFailure(error) {
        // Handle scan failure, usually better to ignore to avoid console spam
    }

    // --- 4. Saving Data Logic ---
    function saveEntry() {
        const qrData = document.getElementById('qr-data').value;
        const itemType = document.getElementById('item-select').value;

        if (!qrData) {
            alert("Please scan a QR code first.");
            return;
        }
        if (!itemType) {
            alert("Please select an item from the list.");
            return;
        }

        const newEntry = {
            timestamp: new Date().toLocaleString(),
            qr: qrData,
            item: itemType
        };

        // Add to array
        savedEntries.push(newEntry);
        
        // Save to LocalStorage
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedEntries));

        // Update UI
        renderTable();
        
        // Clear inputs for next scan
        document.getElementById('qr-data').value = '';
        document.getElementById('item-select').value = '';
    }

    // --- 5. Rendering Table ---
    function renderTable() {
        const tbody = document.querySelector('#data-table tbody');
        tbody.innerHTML = ''; // Clear current rows

        // Loop through saved entries and create rows
        // We reverse the array to show newest first
        savedEntries.slice().reverse().forEach(entry => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${entry.timestamp}</td>
                <td>${entry.qr}</td>
                <td>${entry.item}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // --- 6. Download Excel (CSV) ---
    function downloadExcel() {
        if (savedEntries.length === 0) {
            alert("No data to download.");
            return;
        }

        // CSV Header
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Time,QR Data,Selected Item\n";

        // CSV Rows
        savedEntries.forEach(entry => {
            const row = `${entry.timestamp},"${entry.qr}","${entry.item}"`;
            csvContent += row + "\n";
        });

        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "qr_scan_data.csv");
        document.body.appendChild(link);
        
        link.click(); // Trigger download
        document.body.removeChild(link); // Clean up
    }

    // --- 7. Clear Data ---
    function clearAllData() {
        if (confirm("Are you sure you want to delete all saved history?")) {
            savedEntries = [];
            localStorage.removeItem(STORAGE_KEY);
            renderTable();
        }
    }
</script>

</body>
</html>
