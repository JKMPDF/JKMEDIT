<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24/7 Radio + DJ Override</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #ff0055; --accent: #00d2ff; --bg: #000000; --panel: #1a1a1a; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* STATUS BAR */
        #status-bar { position: fixed; top: 0; left: 0; width: 100%; background: #222; color: #aaa; padding: 5px; font-size: 12px; text-align: center; border-bottom: 1px solid #333; z-index: 900; }
        
        /* PLAYER CARD */
        .player-card { 
            background: var(--panel); border: 1px solid #333; padding: 0; 
            border-radius: 15px; text-align: center; width: 95%; max-width: 600px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); overflow: hidden; position: relative;
        }
        
        /* VIDEO WRAPPER */
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: #000; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* LIVE OVERLAY (Shows when DJ is manual) */
        #live-overlay {
            position: absolute; top: 10px; right: 10px; background: red; color: white;
            padding: 5px 10px; font-size: 12px; font-weight: bold; border-radius: 4px;
            display: none; animation: blink 2s infinite; z-index: 20;
        }
        @keyframes blink { 50% { opacity: 0.5; } }

        .info-area { padding: 20px; }
        h1 { margin: 0; font-size: 1.4rem; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
        h3 { color: var(--accent); margin: 5px 0 20px 0; font-size: 0.9rem; font-weight: bold; }
        
        #start-btn { 
            padding: 15px 50px; font-size: 1.2rem; background: var(--primary); 
            color: white; border: none; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.4); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255,0,85,0.7);} 70% {box-shadow: 0 0 0 10px rgba(255,0,85,0);} 100% {box-shadow: 0 0 0 0 rgba(255,0,85,0);} }

        /* ADMIN PANEL */
        .admin-trigger { position: fixed; bottom: 20px; right: 20px; color: #333; cursor: pointer; font-size: 1.5rem; z-index: 1000; transition: color 0.3s; }
        .admin-trigger:hover { color: var(--accent); }

        #admin-panel { 
            position: fixed; top: 0; right: -400px; width: 340px; height: 100vh; 
            background: #111; border-left: 1px solid #333; transition: right 0.3s ease; 
            z-index: 2000; padding: 25px; display: flex; flex-direction: column; overflow-y: auto;
        }
        #admin-panel.open { right: 0; }
        
        .control-group { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
        label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        button.admin-btn { width: 100%; padding: 10px; background: #333; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; margin-top: 5px; transition: background 0.2s; }
        button.admin-btn:hover { background: #444; }
        button.primary { background: var(--accent); color: black; }
        button.danger { background: var(--primary); color: white; }
        button.success { background: #00ff00; color: black; }
    </style>
</head>
<body>

    <div id="status-bar">Initializing System...</div>

    <div class="player-card">
        <div id="live-overlay">üî¥ DJ LIVE CONTROL</div>
        <div class="video-wrapper">
            <div id="player"></div>
        </div>
        <div class="info-area">
            <h1 id="song-title">Connecting...</h1>
            <h3 id="debug-info">Waiting for Data</h3>
            <button id="start-btn" onclick="startAudio()">START RADIO</button>
        </div>
    </div>

    <div class="admin-trigger" onclick="toggleAdmin()"><i class="fas fa-cog"></i></div>

    <div id="admin-panel">
        <h2 style="margin-top:0">DJ CONTROLS <span onclick="toggleAdmin()" style="float:right; cursor:pointer;">&times;</span></h2>
        
        <div class="control-group" style="border: 1px solid red;">
            <label style="color:red; font-weight:bold;">üî• Play Immediately (Override)</label>
            <input type="text" id="manual-url" placeholder="Paste YouTube Link">
            <input type="text" id="manual-title" placeholder="Song Title (Optional)">
            <button class="admin-btn danger" onclick="playManual()">FORCE PLAY NOW</button>
            <button class="admin-btn" onclick="stopManual()" style="margin-top:10px;">‚èπ Stop & Resume Auto 24/7</button>
        </div>

        <div class="control-group">
            <label style="color:var(--accent);">üì° Auto-Play Channel</label>
            <select id="live-genre-select" onchange="changeLiveGenre()">
                <option value="all">üåç Global Mix</option>
                <option value="bollywood">üáÆüá≥ Bollywood</option>
                <option value="english">üá∫üá∏ English Pop</option>
                <option value="romantic">‚ù§Ô∏è Romantic</option>
            </select>
        </div>

        <div class="control-group">
            <label>üíæ Add to 24/7 Loop</label>
            <input type="text" id="add-url" placeholder="YouTube Link">
            <input type="text" id="add-title" placeholder="Song Title">
            <input type="number" id="add-duration" placeholder="Duration (Seconds)">
            <select id="add-category">
                <option value="bollywood">Bollywood</option>
                <option value="english">English</option>
                <option value="romantic">Romantic</option>
            </select>
            <button class="admin-btn primary" onclick="addSong()">Add to Database</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // ‚¨áÔ∏è‚¨áÔ∏è PASTE CONFIG HERE ‚¨áÔ∏è‚¨áÔ∏è
        const firebaseConfig = {
  apiKey: "AIzaSyDkhqOMIFrgs_obaub-YblXuBLnbaGlZXQ",
  authDomain: "jkm-music.firebaseapp.com",
  projectId: "jkm-music",
  storageBucket: "jkm-music.firebasestorage.app",
  messagingSenderId: "622011433252",
  appId: "1:622011433252:web:6df9638a3d544b7c5fb3b1"
};

        // ‚¨ÜÔ∏è‚¨ÜÔ∏è END CONFIG ‚¨ÜÔ∏è‚¨ÜÔ∏è

        // --- 1. INITIALIZE ---
        try {
            firebase.initializeApp(firebaseConfig);
            var db = firebase.database();
            document.getElementById('status-bar').innerText = "‚úÖ System Connected";
        } catch(e) {
            document.getElementById('status-bar').innerText = "‚ùå Config Error";
            document.getElementById('status-bar').style.background = "red";
        }

        var library = [];
        var player;
        var syncInterval;
        var currentGenre = "all";
        var manualState = null; // Stores manual play data

        // --- 2. LISTENERS ---
        
        // A. Listen for Manual Override
        db.ref('radio/state/manual').on('value', function(snap) {
            manualState = snap.val();
            if (manualState) {
                document.getElementById('live-overlay').style.display = "block";
                console.log("Manual Mode Active");
                syncRadio(); // Trigger immediate update
            } else {
                document.getElementById('live-overlay').style.display = "none";
                console.log("Auto Mode Active");
                syncRadio();
            }
        });

        // B. Listen for Genre
        db.ref('radio/state/currentGenre').on('value', function(snap) {
            if(snap.val()) {
                currentGenre = snap.val();
                document.getElementById('live-genre-select').value = currentGenre;
            }
        });

        // C. Listen for Library
        db.ref('radio/library').on('value', function(snapshot) {
            var data = snapshot.val();
            if (data) library = Object.values(data);
        });

        // --- 3. YOUTUBE PLAYER ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                playerVars: { 'autoplay': 0, 'controls': 1, 'playsinline': 1 },
                events: { 'onReady': function() { console.log("Player Ready"); } }
            });
        }

        window.startAudio = function() {
            document.getElementById('start-btn').style.display = 'none';
            if(syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(syncRadio, 1000);
            syncRadio();
        };

        // --- 4. THE BRAIN (SYNC LOGIC) ---
        function syncRadio() {
            if (!player || !player.loadVideoById) return;
            var now = Date.now();

            // === PRIORITY 1: MANUAL OVERRIDE ===
            if (manualState) {
                var elapsed = (now - manualState.startTime) / 1000;
                
                // If song ended (assume 10 mins max for manual if undefined), stop manual
                if (elapsed > 600) { 
                    // Optional: You could auto-cancel manual here
                }

                document.getElementById('song-title').innerText = "üëë DJ LIVE: " + manualState.title;
                document.getElementById('debug-info').innerText = "Live Time: " + Math.floor(elapsed) + "s";
                
                playVideoSafe(manualState.id, elapsed);
                return; // Stop here, do not run Auto Logic
            }

            // === PRIORITY 2: AUTO 24/7 LOOP ===
            if (library.length === 0) {
                document.getElementById('song-title').innerText = "Database Empty";
                return;
            }

            // Filter
            var activePlaylist = library;
            if (currentGenre !== 'all') {
                activePlaylist = library.filter(function(s) {
                    var g = s.genre || "all"; 
                    return g.toLowerCase() === currentGenre.toLowerCase();
                });
            }
            if (activePlaylist.length === 0) activePlaylist = library; // Fallback

            // Math
            var totalDuration = activePlaylist.reduce(function(sum, s) { return sum + parseInt(s.duration); }, 0);
            var loopTime = (now / 1000) % totalDuration;

            // Find Song
            var currentSong = null;
            for (var i = 0; i < activePlaylist.length; i++) {
                var s = activePlaylist[i];
                if (loopTime < s.duration) {
                    currentSong = s;
                    break;
                }
                loopTime -= s.duration;
            }

            if (currentSong) {
                document.getElementById('song-title').innerText = currentSong.title;
                document.getElementById('debug-info').innerText = "Auto: " + Math.floor(loopTime) + "s / " + currentSong.duration + "s";
                playVideoSafe(currentSong.id, loopTime);
            }
        }

        // Helper to prevent stuttering
        function playVideoSafe(id, time) {
            var currentId = "";
            try { currentId = player.getVideoData().video_id; } catch(e){}

            if (currentId !== id) {
                player.loadVideoById(id, time);
            } else {
                var diff = Math.abs(player.getCurrentTime() - time);
                if (diff > 6) player.seekTo(time, true); // Only seek if drift > 6s
            }
            
            var state = player.getPlayerState();
            if (state !== 1 && state !== 3) player.playVideo();
        }

        // --- 5. ADMIN FUNCTIONS ---
        window.toggleAdmin = function() {
            document.getElementById('admin-panel').classList.toggle('open');
        };

        // A. PLAY NOW (MANUAL)
        window.playManual = function() {
            var url = document.getElementById('manual-url').value;
            var id = url.split('v=')[1] || url.split('/').pop();
            if(id.indexOf('&') > -1) id = id.split('&')[0];
            
            if(!id) return alert("Invalid URL");

            db.ref('radio/state/manual').set({
                id: id,
                title: document.getElementById('manual-title').value || "Manual Pick",
                startTime: Date.now()
            });
            alert("Playing Now!");
        };

        // B. STOP MANUAL
        window.stopManual = function() {
            db.ref('radio/state/manual').remove();
            alert("Resumed Auto Mode");
        };

        // C. CHANGE GENRE
        window.changeLiveGenre = function() {
            db.ref('radio/state/currentGenre').set(document.getElementById('live-genre-select').value);
        };

        // D. ADD SONG
        window.addSong = function() {
            var url = document.getElementById('add-url').value;
            var id = url.split('v=')[1] || url.split('/').pop();
            if(id.indexOf('&') > -1) id = id.split('&')[0];

            db.ref('radio/library').push({
                id: id,
                title: document.getElementById('add-title').value,
                duration: document.getElementById('add-duration').value,
                genre: document.getElementById('add-category').value
            });
            alert("Song Added to Loop!");
        };

    </script>
</body>
</html>
