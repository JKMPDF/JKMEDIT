<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Emergency Fix</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; text-align: center; }
        #status-box { border: 2px solid #fff; padding: 20px; margin: 20px auto; max-width: 600px; background: #222; }
        h1 { color: white; }
        .error { color: red; font-weight: bold; font-size: 1.2em; }
        .success { color: #0f0; }
        input { padding: 10px; width: 70%; }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üì° RADIO DIAGNOSTICS</h1>

    <div id="status-box">
        <p id="step-1">1. Loading Scripts... <span style="color:yellow">WAITING</span></p>
        <p id="step-2">2. Firebase Connection... <span style="color:yellow">WAITING</span></p>
        <p id="step-3">3. Database Read... <span style="color:yellow">WAITING</span></p>
        <hr>
        <p id="final-message" style="font-size: 1.2em;">Initializing...</p>
    </div>

    <div id="player-ui" style="display:none;">
        <h2 id="now-playing">üé∂ Song Title</h2>
        <div id="player"></div>
    </div>

    <div id="init-area" style="display:none; margin-top:30px; border-top:1px solid #555; padding-top:20px;">
        <h3 style="color:orange">‚ö†Ô∏è DATABASE IS EMPTY</h3>
        <p>The radio works, but you have 0 songs saved.</p>
        <button onclick="addDefaultSong()" style="background:orange;">CLICK TO ADD TEST SONG</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // === ERROR CATCHER ===
        window.onerror = function(msg, url, line) {
            document.getElementById('final-message').innerHTML = `<span class="error">‚ùå CODE CRASHED: ${msg} (Line ${line})</span>`;
            return false;
        };

        // 1. UPDATE STATUS
        document.getElementById('step-1').innerHTML = "1. Loading Scripts... <span class='success'>‚úÖ OK</span>";

        // ‚¨áÔ∏è‚¨áÔ∏è PASTE YOUR FIREBASE CONFIG HERE ‚¨áÔ∏è‚¨áÔ∏è
        // (Make sure you copy ONLY the keys, no script tags!)
       const firebaseConfig = {
  apiKey: "AIzaSyDkhqOMIFrgs_obaub-YblXuBLnbaGlZXQ",
  authDomain: "jkm-music.firebaseapp.com",
  projectId: "jkm-music",
  storageBucket: "jkm-music.firebasestorage.app",
  messagingSenderId: "622011433252",
  appId: "1:622011433252:web:6df9638a3d544b7c5fb3b1"
};
        // ‚¨ÜÔ∏è‚¨ÜÔ∏è END PASTE ‚¨ÜÔ∏è‚¨ÜÔ∏è

        // 2. INITIALIZE FIREBASE
        try {
            firebase.initializeApp(firebaseConfig);
            document.getElementById('step-2').innerHTML = "2. Firebase Connection... <span class='success'>‚úÖ OK</span>";
        } catch (e) {
            document.getElementById('step-2').innerHTML = "2. Firebase Connection... <span class='error'>‚ùå FAILED (Check Config)</span>";
            throw e;
        }

        // 3. CHECK DATABASE
        var db = firebase.database();
        var library = [];
        var player;

        db.ref('radio/library').on('value', function(snapshot) {
            document.getElementById('step-3').innerHTML = "3. Database Read... <span class='success'>‚úÖ OK</span>";
            var data = snapshot.val();

            if (data) {
                // SONGS FOUND!
                library = Object.values(data);
                document.getElementById('final-message').innerText = `‚úÖ SUCCESS! Loaded ${library.length} songs. Starting Radio...`;
                document.getElementById('player-ui').style.display = "block";
                document.getElementById('init-area').style.display = "none";
                startRadioLogic();
            } else {
                // EMPTY DATABASE
                document.getElementById('final-message').innerHTML = "<span class='error'>‚ö†Ô∏è CONNECTED BUT EMPTY</span>";
                document.getElementById('init-area').style.display = "block";
            }
        }, function(error) {
            // PERMISSION DENIED
            document.getElementById('step-3').innerHTML = "3. Database Read... <span class='error'>‚ùå DENIED</span>";
            document.getElementById('final-message').innerHTML = "Error: " + error.message + "<br>Check Firebase Console -> Realtime Database -> Rules";
        });

        // 4. ADD TEST SONG FUNCTION
        window.addDefaultSong = function() {
            db.ref('radio/library').push({
                id: "jfKfPfyJRdk",
                title: "Lofi Girl Radio",
                duration: 3000,
                genre: "lofi"
            });
            alert("Test Song Added! Radio should start in 2 seconds.");
        }

        // 5. RADIO LOGIC
        function startRadioLogic() {
            if (!window.YT) return; // Wait for YouTube API
            
            // Loop Logic
            setInterval(function() {
                if(!player || !player.loadVideoById) return;

                var now = Date.now();
                var totalDuration = library.reduce((sum, s) => sum + parseInt(s.duration), 0);
                var loopTime = (now / 1000) % totalDuration;

                var currentSong = null;
                for (var i = 0; i < library.length; i++) {
                    var s = library[i];
                    if (loopTime < s.duration) {
                        currentSong = s;
                        break;
                    }
                    loopTime -= s.duration;
                }

                if (currentSong) {
                    document.getElementById('now-playing').innerText = "üé∂ " + currentSong.title;
                    
                    var state = player.getPlayerState();
                    // If not playing the right song
                    try {
                         if (player.getVideoData().video_id !== currentSong.id) {
                            player.loadVideoById(currentSong.id, loopTime);
                        } else if (Math.abs(player.getCurrentTime() - loopTime) > 4) {
                            player.seekTo(loopTime, true);
                        }
                    } catch(e) {}
                    
                    if(state !== 1 && state !== 3) player.playVideo();
                }
            }, 1000);
        }

        // 6. YOUTUBE SETUP
        window.onYouTubeIframeAPIReady = function() {
            player = new YT.Player('player', {
                height: '360', width: '640',
                playerVars: { 'autoplay': 1, 'controls': 1 },
                events: {
                    'onReady': function() { console.log("Player Ready"); }
                }
            });
        };
    </script>
</body>
</html>
