<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JKM ULTRA-STUDIO V6 | Pro Lyric Suite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --accent: #00d2ff; --bg: #050505; --panel: #111113; --border: #2a2a2c; --success: #32d74b; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* 3-Column Layout */
        .wing-left { width: 300px; background: var(--panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .center-stage { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        .wing-right { width: 480px; background: var(--panel); border-left: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 12px; }

        /* Stage UI */
        .stage-header { background: #1a1a1c; padding: 10px; display: flex; justify-content: center; gap: 10px; border-bottom: 1px solid var(--border); }
        .canvas-wrap { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
        #vPreview { background: #000; border: 1px solid #333; max-width: 100%; max-height: 100%; }

        /* Inputs */
        .label { font-size: 0.7rem; color: var(--accent); text-transform: uppercase; font-weight: 800; letter-spacing: 1px; }
        textarea, input, select { background: #000; color: #fff; border: 1px solid #333; padding: 10px; border-radius: 8px; width: 100%; font-size: 0.85rem; box-sizing: border-box; }
        
        /* Timeline Professional Rows */
        .tl-scroll { flex: 1; background: #09090b; border-radius: 12px; border: 1px solid #222; overflow-y: auto; padding: 10px; }
        .tl-row { 
            display: flex; gap: 6px; margin-bottom: 8px; background: #1a1a1c; padding: 8px; 
            border-radius: 8px; align-items: center; border: 1px solid transparent; transition: 0.2s;
        }
        .tl-row:hover { border-color: var(--accent); background: #1f1f22; }
        .timestamp { 
            color: var(--accent); font-family: monospace; font-weight: bold; width: 85px; 
            cursor: pointer; background: #000; padding: 5px; border-radius: 4px; text-align: center;
        }
        .timestamp:hover { background: var(--accent); color: #000; }

        .btn { border: none; border-radius: 8px; padding: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-sync { background: var(--success); color: #000; height: 50px; font-size: 1rem; }
        .btn-res { background: #000; color: #666; border: 1px solid #333; padding: 8px 15px; }
        .btn-res.active { border-color: var(--accent); color: var(--accent); background: rgba(0,210,255,0.1); }

        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .clr-p { width: 30px; height: 30px; padding: 0; border: none; cursor: pointer; background: none; }
    </style>
</head>
<body>

<div class="wing-left" id="lWing">
    <h2 style="margin:0; font-size: 1.1rem; color: var(--accent);">JKM PRO | ELITE</h2>
    <div class="group">
        <div class="label">1. Assets</div>
        <input type="file" id="audioIn" accept="audio/mp3">
        <div style="margin-top:10px"><input type="file" id="bgIn" accept="image/*"></div>
    </div>
    <div class="group">
        <div class="label">2. Default Style</div>
        <div style="display:flex; gap:5px">
            <input type="color" id="defTxt" value="#ffffff" title="Text">
            <input type="color" id="defGlw" value="#00d2ff" title="Glow">
            <select id="anim"><option value="pop">Pop</option><option value="fade">Fade</option></select>
        </div>
    </div>
    <div style="margin-top:auto">
        <audio id="audio" controls style="width: 100%;"></audio>
        <button id="renderBtn" class="btn" style="display:none; margin-top:10px; background:#ff453a; color:white; width:100%" onclick="startRender()">EXPORT VIDEO</button>
    </div>
</div>

<div class="center-stage">
    <div class="stage-header">
        <button id="r169" class="btn btn-res active" onclick="setR(1920, 1080, 'r169')">16:9 Landscape</button>
        <button id="r916" class="btn btn-res" onclick="setR(1080, 1920, 'r916')">9:16 Portrait</button>
    </div>
    <div class="canvas-wrap"><canvas id="vPreview"></canvas></div>
    <div id="renderOverlay" class="overlay">
        <i class="fa-solid fa-compact-disc fa-spin fa-4x" style="color:var(--accent)"></i>
        <h2>PRODUCING 4K VIDEO...</h2>
        <p style="color:#666">M&M❣️ Exclusive Studio Rendering</p>
    </div>
</div>

<div class="wing-right" id="rWing">
    <div class="label">Master Script</div>
    <textarea id="lyricIn" rows="6">Hello M&M❣️&#10;Click timestamps to jump music&#10;Each line has its own color!</textarea>
    <button class="btn btn-sync" onclick="sync()"><i class="fa-solid fa-plus"></i> SYNC LINE</button>
    
    <div class="label" style="margin-top:10px">Timeline (Click time to Seek)</div>
    <div class="tl-scroll" id="tl"></div>
</div>

<script>
    const canvas = document.getElementById('vPreview');
    const ctx = canvas.getContext('2d');
    const audio = document.getElementById('audio');
    const tl = document.getElementById('tl');
    
    let synced = [];
    let bgImg = null;
    let animVal = 0;
    let lastText = "";

    function format(s) {
        const m = Math.floor(s/60);
        const sec = Math.floor(s%60);
        const ms = Math.floor((s%1)*1000);
        return `${m}:${sec.toString().padStart(2,'0')}:${ms.toString().padStart(3,'0')}`;
    }

    function setR(w, h, id) {
        canvas.width = w; canvas.height = h;
        document.querySelectorAll('.btn-res').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    setR(1920, 1080, 'r169');

    document.getElementById('bgIn').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => { bgImg = new Image(); bgImg.src = f.target.result; };
        reader.readAsDataURL(e.target.files[0]);
    };

    document.getElementById('audioIn').onchange = (e) => {
        audio.src = URL.createObjectURL(e.target.files[0]);
    };

    function sync() {
        if (audio.paused) return alert("Play audio first!");
        let lines = document.getElementById('lyricIn').value.split('\n').filter(l => l.trim() !== "");
        if (synced.length < lines.length) {
            synced.push({ 
                time: audio.currentTime, 
                text: lines[synced.length],
                color: document.getElementById('defTxt').value,
                glow: document.getElementById('defGlw').value
            });
            renderTL();
        }
    }

    function renderTL() {
        tl.innerHTML = "";
        synced.forEach((s, i) => {
            const d = document.createElement('div');
            d.className = "tl-row";
            d.innerHTML = `
                <div class="timestamp" onclick="audio.currentTime=${s.time}">${format(s.time)}</div>
                <input type="text" value="${s.text}" onchange="synced[${i}].text=this.value" style="flex:1">
                <input type="color" class="clr-p" value="${s.color}" onchange="synced[${i}].color=this.value">
                <input type="color" class="clr-p" value="${s.glow}" onchange="synced[${i}].glow=this.value">
                <button onclick="synced.splice(${i},1);renderTL()" style="background:none;border:none;color:red;cursor:pointer">×</button>
            `;
            tl.appendChild(d);
        });
        tl.scrollTop = tl.scrollHeight;
        if(synced.length > 0) document.getElementById('renderBtn').style.display = "block";
    }

    function wrap(text, maxWidth) {
        let words = text.split(' '), lines = [], cur = words[0];
        for (let i = 1; i < words.length; i++) {
            if (ctx.measureText(cur + " " + words[i]).width < maxWidth) cur += " " + words[i];
            else { lines.push(cur); cur = words[i]; }
        }
        lines.push(cur); return lines;
    }

    function draw(text, tCol, gCol) {
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
        if(bgImg) { ctx.drawImage(bgImg,0,0,canvas.width,canvas.height); ctx.fillStyle="rgba(0,0,0,0.4)"; ctx.fillRect(0,0,canvas.width,canvas.height); }
        
        if (text) {
            if(lastText !== text){ animVal = 0; lastText = text; }
            if(animVal < 1) animVal += 0.05;
            
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            if(document.getElementById('anim').value === 'pop') ctx.scale(0.8+(animVal*0.2), 0.8+(animVal*0.2));
            
            ctx.globalAlpha = animVal;
            ctx.fillStyle = tCol;
            ctx.shadowBlur = 40 * animVal;
            ctx.shadowColor = gCol;
            ctx.font = `bold ${canvas.width/16}px sans-serif`;
            ctx.textAlign = "center";
            
            const wrapped = wrap(text, canvas.width * 0.85); // Auto-wrap based on current width
            wrapped.forEach((l, i) => {
                ctx.fillText(l, 0, (i * (canvas.width/14)) - (wrapped.length * (canvas.width/28)));
            });
            ctx.restore();
        }
    }

    function loop() {
        let active = null;
        for (let s of synced) { if (audio.currentTime >= s.time) active = s; }
        if(active) draw(active.text, active.color, active.glow);
        else draw("");
        requestAnimationFrame(loop);
    }
    loop();

    async function startRender() {
        document.getElementById('renderOverlay').style.display = "flex";
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaElementSource(audio);
        const dest = audioCtx.createMediaStreamDestination();
        source.connect(dest); source.connect(audioCtx.destination); 
        
        const combined = new MediaStream([...canvas.captureStream(60).getVideoTracks(), ...dest.stream.getAudioTracks()]);
        const recorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 18000000 });
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(chunks, {type:'video/webm'}));
            a.download = "JKM_ELITE_VIDEO.webm"; a.click(); location.reload();
        };
        audio.currentTime = 0; audio.play(); recorder.start();
        audio.onended = () => recorder.stop();
    }
</script>
</body>
</html>