<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JKM Edit - Bank Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .numeric { font-family: 'Courier New', monospace; text-align: right; }
        
        /* Accordion Animation */
        .sub-row {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
            background-color: #f8fafc;
        }
        .sub-row.open { opacity: 1; }
        
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #4f46e5; }
        .main-row:hover { background-color: #f1f5f9; }
        
        /* Buttons visibility on hover */
        .action-btn { visibility: hidden; }
        .sub-row-content:hover .action-btn { visibility: visible; }
        .group-action-btn { visibility: hidden; }
        .main-row:hover .group-action-btn { visibility: visible; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 50;
        }
        .modal-box {
            background: white; padding: 2rem; border-radius: 12px;
            width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="relative bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center shadow-sm z-20">
        
        <!-- LEFT SIDE: Logo + JKM Edit -->
        <div class="flex items-center gap-3 z-10">
            <!-- Logo from assets folder -->
            <img src="assets/jkm-edit-logo.png" alt="Logo" class="h-10 w-auto object-contain" 
                 onerror="this.style.display='none'; document.getElementById('fallback-icon').style.display='block'">
            
            <!-- Fallback Icon (shows if image is missing) -->
            <div id="fallback-icon" class="bg-indigo-600 text-white p-2 rounded-lg hidden">
                <i class="ph ph-bank text-xl"></i>
            </div>
            
            <h1 class="text-xl font-bold text-gray-800 tracking-wide">JKM Edit</h1>
        </div>

        <!-- MIDDLE: BANK Analysis (Centered) -->
        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2">
            <h2 class="text-2xl font-extrabold text-indigo-700 tracking-tight uppercase">BANK Analysis</h2>
        </div>

        <!-- RIGHT SIDE: Action Buttons -->
        <div class="flex gap-3 z-10">
            <button onclick="downloadTemplate()" class="px-4 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                <i class="ph ph-file-xls mr-2"></i>Template
            </button>
            <button onclick="document.getElementById('fileInput').click()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition shadow-sm">
                <i class="ph ph-upload-simple mr-2"></i>Upload Excel
            </button>
            <button onclick="exportData()" id="exportBtn" class="hidden px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 transition shadow-sm">
                <i class="ph ph-download-simple mr-2"></i>Export
            </button>
            <input type="file" id="fileInput" hidden accept=".xlsx, .xls">
        </div>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- SIDEBAR -->
        <aside class="w-64 bg-white border-r border-gray-200 p-6 flex flex-col gap-6">
            <div>
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Total Inflow (Credit)</p>
                <p class="text-2xl font-bold text-emerald-600 mt-1" id="totalCredit">0.00</p>
            </div>
            <div>
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Total Outflow (Debit)</p>
                <p class="text-2xl font-bold text-red-600 mt-1" id="totalDebit">0.00</p>
            </div>
            <div class="pt-4 border-t border-gray-100">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Net Balance</p>
                <p class="text-2xl font-bold text-gray-800 mt-1" id="netFlow">0.00</p>
            </div>
            <div class="mt-auto bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                <p class="font-bold mb-1">Controls:</p>
                <ul class="list-disc pl-4 space-y-1 text-xs">
                    <li><strong>Add to Existing:</strong> Select items -> click button -> choose group.</li>
                    <li><strong>Dissolve Group:</strong> Click <i class="ph ph-trash"></i> on a group row.</li>
                </ul>
            </div>
        </aside>

        <!-- CONTENT -->
        <main class="flex-1 flex flex-col bg-gray-50">
            
            <!-- TOOLBAR -->
            <div id="toolbar" class="hidden px-6 py-4 flex gap-4 items-center border-b border-gray-200 bg-white">
                <div class="relative flex-1 max-w-md">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchInput" oninput="filterData()" placeholder="Search..." 
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div class="h-8 w-px bg-gray-300 mx-2"></div>
                
                <!-- NEW: Add to Existing Group Button -->
                <button onclick="openAddToGroupModal()" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition">
                    <i class="ph ph-plus-circle"></i> Add to Existing
                </button>

                <!-- Merge New Button -->
                <button onclick="mergeSelected()" class="flex items-center gap-2 px-4 py-2 bg-indigo-100 text-indigo-700 font-medium rounded-lg hover:bg-indigo-200 transition">
                    <i class="ph ph-arrows-merge"></i> Merge New Group
                </button>
            </div>

            <!-- TABLE -->
            <div class="flex-1 overflow-y-auto p-6">
                <div id="emptyState" class="flex flex-col items-center justify-center h-full text-gray-400">
                    <i class="ph ph-table text-6xl mb-4 text-gray-300"></i>
                    <p class="text-lg">Upload an Excel file to start</p>
                </div>

                <div id="tableWrapper" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500 font-semibold text-sm border-b border-gray-200">
                            <tr>
                                <th class="p-4 w-12 text-center"><input type="checkbox" onclick="toggleSelectAll(this)" class="custom-checkbox"></th>
                                <th class="p-4">Description / Group Name</th>
                                <th class="p-4 text-center">Count</th>
                                <th class="p-4 text-right">Debit</th>
                                <th class="p-4 text-right">Credit</th>
                                <th class="p-4 text-right">Net</th>
                                <th class="p-4 w-16"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-sm divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL: Add to Existing Group -->
    <div id="groupSelectionModal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="text-xl font-bold mb-4">Select Target Group</h2>
            <p class="text-gray-600 mb-4 text-sm">Choose an existing group to move the selected items into:</p>
            
            <select id="groupSelectDropdown" class="w-full p-2 border border-gray-300 rounded-lg mb-6 bg-white">
                <!-- Options populated by JS -->
            </select>

            <div class="flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                <button onclick="confirmAddToGroup()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Move Items</button>
            </div>
        </div>
    </div>

    <script>
        let transactions = []; 
        let currentFilter = "";

        // --- CORE FUNCTIONS ---
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                initializeData(json);
            };
            reader.readAsArrayBuffer(file);
        });

        function downloadTemplate() {
            const ws = XLSX.utils.aoa_to_sheet([["Date", "Narration/Particular", "Transaction ID", "Debit", "Credit"]]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "Template.xlsx");
        }

        function formatCurrency(num) {
            return num.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function initializeData(rawData) {
            transactions = rawData.map((row, index) => {
                let rawName = row["Narration/Particular"] || "Unknown";
                return {
                    id: "tx_" + index + "_" + Date.now(),
                    date: row["Date"] || "",
                    originalName: rawName,
                    cleanName: cleanName(rawName),
                    debit: parseFloat(row["Debit"]) || 0,
                    credit: parseFloat(row["Credit"]) || 0,
                    groupId: null, 
                    groupName: null 
                };
            });
            autoGroupData();
            renderUI();
        }

        function cleanName(name) {
            let str = String(name).toUpperCase();
            ["UPI", "IMPS", "NEFT", "RTGS", "REF", "TRANSFER", "TO", "BY", "/", "-"].forEach(w => str = str.replace(w, ""));
            return str.replace(/[0-9]/g, "").replace(/\s+/g, " ").trim();
        }

        function autoGroupData() {
            const groups = {};
            transactions.forEach(tx => {
                const key = tx.cleanName || "Others";
                if (!groups[key]) groups[key] = [];
                groups[key].push(tx);
            });
            Object.keys(groups).forEach(key => {
                const groupTxns = groups[key];
                if (groupTxns.length > 1) {
                    const newGroupId = "grp_" + Math.random().toString(36).substr(2, 9);
                    groupTxns.forEach(tx => {
                        tx.groupId = newGroupId;
                        tx.groupName = key;
                    });
                } else {
                    tx = groupTxns[0];
                    tx.groupId = tx.id;
                    tx.groupName = tx.originalName;
                }
            });
        }

        // --- RENDER LOGIC ---
        function getAggregatedView() {
            const map = {};
            transactions.forEach(tx => {
                if (currentFilter) {
                    const searchStr = (tx.originalName + " " + tx.groupName).toLowerCase();
                    if (!searchStr.includes(currentFilter.toLowerCase())) return;
                }
                if (!map[tx.groupId]) {
                    map[tx.groupId] = {
                        groupId: tx.groupId,
                        displayName: tx.groupName,
                        items: [],
                        totalDebit: 0,
                        totalCredit: 0
                    };
                }
                map[tx.groupId].items.push(tx);
                map[tx.groupId].totalDebit += tx.debit;
                map[tx.groupId].totalCredit += tx.credit;
            });
            return Object.values(map).sort((a,b) => b.items.length - a.items.length);
        }

        function renderUI() {
            const data = getAggregatedView();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            let gd = 0, gc = 0;

            data.forEach(group => {
                gd += group.totalDebit;
                gc += group.totalCredit;
                const net = group.totalDebit - group.totalCredit;
                const isMerged = group.items.length > 1;

                const tr = document.createElement('tr');
                tr.className = "main-row border-b border-gray-100 transition-colors";
                if(isMerged) tr.style.cursor = "pointer";
                
                tr.onclick = (e) => {
                    if(e.target.type === 'checkbox' || e.target.closest('button')) return;
                    if(isMerged) toggleSubRow(group.groupId);
                };

                tr.innerHTML = `
                    <td class="p-4 text-center">
                        <input type="checkbox" class="custom-checkbox row-select" value="${group.groupId}">
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            ${isMerged ? `<i id="icon_${group.groupId}" class="ph ph-caret-right text-gray-400"></i>` : ''}
                            <span class="font-medium text-gray-800">${group.displayName}</span>
                            ${isMerged ? `<span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full">Group</span>` : ''}
                        </div>
                    </td>
                    <td class="p-4 text-center text-gray-500">${group.items.length}</td>
                    <td class="p-4 numeric ${group.totalDebit > 0 ? 'text-red-600' : 'text-gray-300'}">${formatCurrency(group.totalDebit)}</td>
                    <td class="p-4 numeric ${group.totalCredit > 0 ? 'text-emerald-600' : 'text-gray-300'}">${formatCurrency(group.totalCredit)}</td>
                    <td class="p-4 numeric font-bold text-gray-700">${formatCurrency(net)}</td>
                    <td class="p-4 text-right">
                        ${isMerged ? 
                            `<button onclick="dissolveGroup('${group.groupId}')" title="Dissolve Group (Remove all items)" 
                              class="group-action-btn text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 p-2 rounded transition">
                              <i class="ph ph-trash"></i>
                             </button>` 
                            : ''}
                    </td>
                `;
                tbody.appendChild(tr);

                if (isMerged) {
                    const subTr = document.createElement('tr');
                    subTr.innerHTML = `
                        <td colspan="7" class="p-0 border-none">
                            <div id="sub_${group.groupId}" class="sub-row bg-gray-50 shadow-inner">
                                <table class="w-full">
                                    ${group.items.map(item => `
                                        <tr class="sub-row-content border-b border-gray-100 hover:bg-gray-100">
                                            <td class="p-3 w-12"></td>
                                            <td class="p-3 pl-12 text-sm text-gray-600 flex items-center gap-3">
                                                <span class="text-xs text-gray-400 font-mono">${item.date || '-'}</span>
                                                ${item.originalName}
                                            </td>
                                            <td class="p-3"></td>
                                            <td class="p-3 numeric text-sm text-gray-500">${item.debit ? formatCurrency(item.debit) : '-'}</td>
                                            <td class="p-3 numeric text-sm text-gray-500">${item.credit ? formatCurrency(item.credit) : '-'}</td>
                                            <td class="p-3"></td>
                                            <td class="p-3 text-center">
                                                <button onclick="detachItem('${item.id}')" title="Remove from Group" 
                                                    class="action-btn text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition">
                                                    <i class="ph ph-link-break"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(subTr);
                }
            });

            document.getElementById('totalDebit').innerText = formatCurrency(gd);
            document.getElementById('totalCredit').innerText = formatCurrency(gc);
            document.getElementById('netFlow').innerText = formatCurrency(gd - gc);
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('tableWrapper').classList.remove('hidden');
            document.getElementById('toolbar').classList.remove('hidden');
            document.getElementById('exportBtn').classList.remove('hidden');
        }

        // --- ACTIONS ---

        function toggleSubRow(groupId) {
            const subRow = document.getElementById(`sub_${groupId}`);
            const icon = document.getElementById(`icon_${groupId}`);
            if(!subRow) return;
            if (subRow.style.maxHeight) {
                subRow.style.maxHeight = null;
                subRow.classList.remove('open');
                icon.classList.replace('ph-caret-down', 'ph-caret-right');
            } else {
                subRow.style.maxHeight = subRow.scrollHeight + "px";
                subRow.classList.add('open');
                icon.classList.replace('ph-caret-right', 'ph-caret-down');
            }
        }

        function filterData() {
            currentFilter = document.getElementById('searchInput').value;
            renderUI();
        }

        function toggleSelectAll(source) {
            document.querySelectorAll('.row-select').forEach(cb => cb.checked = source.checked);
        }

        function mergeSelected() {
            const checkboxes = document.querySelectorAll('.row-select:checked');
            const groupIds = Array.from(checkboxes).map(cb => cb.value);
            if (groupIds.length < 2) return alert("Select at least 2 items to merge.");

            const firstTx = transactions.find(t => t.groupId === groupIds[0]);
            const newName = prompt("Enter Name for Merged Group:", firstTx.groupName);
            if (!newName) return;

            const newGroupId = "grp_" + Date.now();
            transactions.forEach(tx => {
                if (groupIds.includes(tx.groupId)) {
                    tx.groupId = newGroupId;
                    tx.groupName = newName;
                }
            });
            renderUI();
        }

        function openAddToGroupModal() {
            const checkboxes = document.querySelectorAll('.row-select:checked');
            if (checkboxes.length === 0) return alert("Please select items to move first.");
            
            const uniqueGroups = new Map();
            transactions.forEach(tx => {
                if(tx.groupId !== tx.id) { 
                    uniqueGroups.set(tx.groupId, tx.groupName);
                }
            });

            const select = document.getElementById('groupSelectDropdown');
            select.innerHTML = '<option value="">-- Select a Group --</option>';
            
            if(uniqueGroups.size === 0) {
                alert("No existing groups found! Use 'Merge New Group' first.");
                return;
            }

            uniqueGroups.forEach((name, id) => {
                select.innerHTML += `<option value="${id}">${name}</option>`;
            });

            document.getElementById('groupSelectionModal').style.display = 'flex';
        }

        function confirmAddToGroup() {
            const targetGroupId = document.getElementById('groupSelectDropdown').value;
            if(!targetGroupId) return alert("Please select a group.");

            const targetTx = transactions.find(t => t.groupId === targetGroupId);
            if(!targetTx) return;

            const checkboxes = document.querySelectorAll('.row-select:checked');
            const selectedOldGroupIds = Array.from(checkboxes).map(cb => cb.value);

            transactions.forEach(tx => {
                if(selectedOldGroupIds.includes(tx.groupId)) {
                    tx.groupId = targetGroupId;
                    tx.groupName = targetTx.groupName;
                }
            });

            closeModal();
            renderUI();
        }

        function closeModal() {
            document.getElementById('groupSelectionModal').style.display = 'none';
        }

        function dissolveGroup(groupId) {
            if(!confirm("Are you sure you want to ungroup all items in this group?")) return;
            transactions.forEach(tx => {
                if(tx.groupId === groupId) {
                    tx.groupId = tx.id;
                    tx.groupName = tx.originalName;
                }
            });
            renderUI();
        }

        function detachItem(itemId) {
            const tx = transactions.find(t => t.id === itemId);
            if (tx) {
                tx.groupId = tx.id;
                tx.groupName = tx.originalName;
                renderUI();
            }
        }

        function exportData() {
            const exportRows = [];
            const data = getAggregatedView();
            data.forEach(g => {
                exportRows.push({
                    "Group Name": g.displayName,
                    "Total Debit": g.totalDebit,
                    "Total Credit": g.totalCredit,
                    "Net": g.totalDebit - g.totalCredit,
                    "Count": g.items.length,
                    "Details": g.items.map(i => `${i.date}: ${i.originalName} (${i.debit||i.credit})`).join('; ')
                });
            });
            const ws = XLSX.utils.json_to_sheet(exportRows);
            const wb = XLSX.utils.book_new();
            ws['!cols'] = [{wch:40}, {wch:15}, {wch:15}, {wch:15}, {wch:10}, {wch:100}];
            XLSX.utils.book_append_sheet(wb, ws, "Analysis");
            XLSX.writeFile(wb, "Final_Analysis.xlsx");
        }
    </script>
</body>
</html>
