<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Asset Auditor</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --primary: #007aff; --bg: #f2f2f7; --card: #ffffff; --text: #1c1c1e; --border: #e5e5ea; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 80px; }
        
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.5rem; }
        .header p { margin: 5px 0 0; color: #8e8e93; font-size: 0.9rem; }

        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Form Elements */
        .form-group { margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .form-group:last-child { border-bottom: none; }
        
        label { font-size: 0.75rem; font-weight: 700; color: #8e8e93; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px; }
        
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fafafa; -webkit-appearance: none; }
        input:focus, select:focus { border-color: var(--primary); outline: none; background: #fff; }

        /* Dynamic List Controls */
        .input-group { display: flex; gap: 8px; }
        .btn-add { background: #e5e5ea; color: #000; border: none; width: 45px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        /* Camera & Photos */
        #qr-reader { border-radius: 10px; overflow: hidden; margin-bottom: 10px; display: none; }
        
        .photo-section { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .photo-btn { 
            border: 2px dashed #007aff; background: #f0f8ff; color: #007aff; 
            padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; display: block;
        }
        .photo-btn img { max-width: 100%; max-height: 150px; margin-top: 10px; display: none; border-radius: 6px; }
        .photo-btn span { font-weight: 600; font-size: 0.9rem; }

        /* Buttons */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: #34c759; color: white; }
        .btn-dark { background: #1c1c1e; color: white; }
        
        /* Overlay */
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; color: white; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <h3 id="loading-text">Processing...</h3>
</div>

<div class="header">
    <h1>Asset Inventory Pro</h1>
    <p>Professional Auditing Tool</p>
</div>

<div class="card">
    <div id="qr-reader"></div>
    <button id="scan-trigger" class="btn btn-blue" onclick="startCamera()">Scan QR Code</button>
</div>

<div class="card">
    <div class="form-group">
        <label>1. Asset ID (From QR)</label>
        <input type="text" id="f_asset_id" readonly placeholder="Scan QR to fill..." style="background-color: #e9e9eb; font-weight: bold;">
    </div>

    <div class="form-group">
        <label>2. Floor</label>
        <div class="input-group">
            <select id="f_floor" onchange="updateSubLocations()"><option value="">Select Floor...</option></select>
            <button class="btn-add" onclick="addItem('f_floor')">+</button>
        </div>
    </div>

    <div class="form-group">
        <label>3. Sub Location (Based on Floor)</label>
        <div class="input-group">
            <select id="f_sub_loc"><option value="">Select Floor First...</option></select>
            <button class="btn-add" onclick="addSubLocationSpecial()">+</button>
        </div>
    </div>
    <div class="form-group">
        <label>4. Asset Category</label>
        <div class="input-group">
            <select id="f_category"><option value="">Select Category...</option></select>
            <button class="btn-add" onclick="addItem('f_category')">+</button>
        </div>
    </div>

    <div class="form-group">
        <label>5. Nature of Asset</label>
        <input type="text" id="f_nature" placeholder="Enter nature...">
    </div>

    <div class="form-group">
        <label>6. Asset Description</label>
        <textarea id="f_desc" rows="3" placeholder="Enter description..."></textarea>
    </div>

    <div class="form-group">
        <label>7. Tagging Status</label>
        <select id="f_tagging">
            <option value="YES">YES</option>
            <option value="NO">NO</option>
        </select>
    </div>

    <div class="form-group">
        <label>8. Make</label>
        <input type="text" id="f_make" placeholder="Brand/Make...">
    </div>

    <div class="form-group">
        <label>9. Model</label>
        <input type="text" id="f_model" placeholder="Model number...">
    </div>

    <div class="form-group">
        <label>10. Serial No.</label>
        <input type="text" id="f_serial" placeholder="Enter serial...">
    </div>

    <div class="form-group">
        <label>11. Quantity</label>
        <input type="number" id="f_qty" value="1" readonly style="background-color: #e9e9eb;">
    </div>

    <div class="form-group">
        <label>12. Type of TAG</label>
        <select id="f_tag_type">
            <option value="Barcode">Barcode</option>
            <option value="Metal">Metal</option>
        </select>
    </div>

    <div class="form-group">
        <label>13. Tag Location</label>
        <input type="text" id="f_tag_loc" placeholder="Where is tag placed?">
    </div>

    <div class="form-group">
        <label>14. Project Name</label>
        <input type="text" id="f_project" placeholder="Project name...">
    </div>

    <div class="form-group">
        <label>15. Email ID / Person Name</label>
        <div class="input-group">
            <select id="f_email"><option value="">Select Person...</option></select>
            <button class="btn-add" onclick="addItem('f_email')">+</button>
        </div>
    </div>

    <div class="form-group">
        <label>16. Department</label>
        <div class="input-group">
            <select id="f_dept"><option value="">Select Department...</option></select>
            <button class="btn-add" onclick="addItem('f_dept')">+</button>
        </div>
    </div>

    <div class="form-group">
        <label>17. Responsible Client Personnel</label>
        <input type="text" id="f_responsible" placeholder="Client personnel name...">
    </div>

    <div class="form-group">
        <label>18. Date & Time (Auto)</label>
        <input type="text" id="f_datetime" readonly placeholder="Will set on save...">
    </div>

    <div class="form-group">
        <label>IMAGES (Click to Capture)</label>
        <div class="photo-section">
            
            <label class="photo-btn">
                <span>19. üì∏ Barcode Image</span>
                <input type="file" id="img_barcode" accept="image/*" capture="environment" hidden onchange="showPreview(this, 'prev_barcode')">
                <img id="prev_barcode">
            </label>

            <label class="photo-btn">
                <span>20. üì∏ Serial No. Image</span>
                <input type="file" id="img_serial" accept="image/*" capture="environment" hidden onchange="showPreview(this, 'prev_serial')">
                <img id="prev_serial">
            </label>

            <label class="photo-btn">
                <span>21. üì∏ Asset Image</span>
                <input type="file" id="img_asset" accept="image/*" capture="environment" hidden onchange="showPreview(this, 'prev_asset')">
                <img id="prev_asset">
            </label>
        </div>
    </div>

    <div class="form-group">
        <label>22. Geo Code</label>
        <div class="input-group">
            <input type="text" id="f_geo" placeholder="Coordinates...">
            <button class="btn-add" style="width:auto; padding:0 10px;" onclick="getGPS()">üìç</button>
        </div>
    </div>

    <div class="form-group">
        <label>23. Remarks</label>
        <input type="text" id="f_remarks" placeholder="Any remarks...">
    </div>

    <button class="btn btn-green" onclick="saveEntry()">SAVE ENTRY</button>
</div>

<div class="card">
    <h3>Database Actions</h3>
    <p>Entries Saved: <b id="db-count">0</b></p>
    <button class="btn btn-dark" onclick="exportData()">Download ZIP (Excel + Photos)</button>
    <button class="btn" style="color:red; background:none; border:1px solid red;" onclick="clearDB()">‚ö† Clear All Data</button>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const DB_NAME = "AssetAuditorProV2"; // New DB name to ensure clean slate for new logic
    const STORE_DATA = "entries";
    let db;
    let qrScanner = null;

    // --- 2. INIT DATABASE ---
    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore(STORE_DATA, { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = e => {
        db = e.target.result;
        updateCount();
        loadListOptions(); 
    };

    // --- 3. DYNAMIC DROPDOWNS LOGIC ---
    
    // Config for standard lists (excluding Sub Location)
    const listConfig = {
        'f_floor': 'Floors',
        'f_category': 'Categories',
        'f_email': 'EmailList',
        'f_dept': 'Departments'
    };

    function addItem(elementId) {
        const val = prompt(`Add new item for ${elementId.replace('f_', '')}:`);
        if(!val) return;
        
        const storageKey = listConfig[elementId];
        let currentList = JSON.parse(localStorage.getItem(storageKey) || "[]");
        if(!currentList.includes(val)) {
            currentList.push(val);
            localStorage.setItem(storageKey, JSON.stringify(currentList));
        }
        
        renderOptions(elementId, currentList);
        document.getElementById(elementId).value = val;
        
        // If floor changed, update sub locations
        if(elementId === 'f_floor') updateSubLocations();
    }

    function loadListOptions() {
        for (const [id, key] of Object.entries(listConfig)) {
            const list = JSON.parse(localStorage.getItem(key) || "[]");
            renderOptions(id, list);
        }
        // Initialize sub locs
        updateSubLocations();
    }

    function renderOptions(elementId, list) {
        const select = document.getElementById(elementId);
        select.innerHTML = '<option value="">Select...</option>';
        list.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.innerText = item;
            select.appendChild(opt);
        });
    }

    // --- SPECIAL LOGIC: FLOOR -> SUB LOCATION ---
    const SUB_LOC_KEY = "SubLocationMap"; // Store as object { "Floor1": ["Loc1", "Loc2"], "Floor2": [] }

    function updateSubLocations() {
        const floorVal = document.getElementById('f_floor').value;
        const subLocSelect = document.getElementById('f_sub_loc');
        
        // clear current options
        subLocSelect.innerHTML = '<option value="">Select...</option>';

        if(!floorVal) {
            subLocSelect.innerHTML = '<option value="">Select Floor First...</option>';
            return;
        }

        // Get map
        const map = JSON.parse(localStorage.getItem(SUB_LOC_KEY) || "{}");
        const locs = map[floorVal] || [];

        locs.forEach(loc => {
            const opt = document.createElement('option');
            opt.value = loc;
            opt.innerText = loc;
            subLocSelect.appendChild(opt);
        });
    }

    function addSubLocationSpecial() {
        const floorVal = document.getElementById('f_floor').value;
        
        if(!floorVal) {
            alert("Please Select a Floor first!");
            return;
        }

        const newLoc = prompt(`Add new Sub Location for Floor: ${floorVal}`);
        if(!newLoc) return;

        const map = JSON.parse(localStorage.getItem(SUB_LOC_KEY) || "{}");
        
        if(!map[floorVal]) map[floorVal] = [];
        
        if(!map[floorVal].includes(newLoc)) {
            map[floorVal].push(newLoc);
            localStorage.setItem(SUB_LOC_KEY, JSON.stringify(map));
            updateSubLocations(); // Refresh list
            document.getElementById('f_sub_loc').value = newLoc; // Select it
        }
    }

    // --- 4. QR SCANNER ---
    function startCamera() {
        document.getElementById('qr-reader').style.display = 'block';
        document.getElementById('scan-trigger').style.display = 'none';
        
        qrScanner = new Html5Qrcode("qr-reader");
        qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
        (text) => {
            alert("QR Code Scanned!\nID: " + text);
            document.getElementById('f_asset_id').value = text;
            stopCamera();
        });
    }

    function stopCamera() {
        if(qrScanner) {
            qrScanner.stop().then(() => {
                document.getElementById('qr-reader').style.display = 'none';
                document.getElementById('scan-trigger').style.display = 'block';
                qrScanner = null;
            });
        }
    }

    // --- 5. GPS ---
    function getGPS() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('f_geo').value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    // --- 6. PHOTO PREVIEW ---
    function showPreview(input, imgId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(imgId);
                img.src = e.target.result;
                img.style.display = "block";
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 7. FILE NAMING & SAVING ---
    function generateUniqueName(prefix, assetId) {
        // Sanitize Asset ID
        const safeId = (assetId || "unknown").replace(/[^a-z0-9]/gi, '_');
        // Random 5 char string
        const randomStr = Math.random().toString(36).substring(2, 7);
        // Time in ms
        const time = Date.now();
        // Result: Prefix_AssetID_Timestamp_Random.jpg
        return `${prefix}_${safeId}_${time}_${randomStr}.jpg`;
    }

    function saveEntry() {
        const assetId = document.getElementById('f_asset_id').value;
        const barcodeFile = document.getElementById('img_barcode').files[0];
        const serialFile = document.getElementById('img_serial').files[0];
        const assetFile = document.getElementById('img_asset').files[0];

        // Validation
        if(!assetId) return alert("Error: Asset ID (QR) is missing.");
        
        document.getElementById('loading-overlay').style.display = 'flex';
        
        const timestamp = new Date().toLocaleString();
        const entryId = Date.now(); 

        const v = (id) => document.getElementById(id).value || "";

        const entry = {
            id: entryId,
            assetId: assetId,
            floor: v('f_floor'),
            subLoc: v('f_sub_loc'),
            category: v('f_category'),
            nature: v('f_nature'),
            desc: v('f_desc'),
            tagging: v('f_tagging'),
            make: v('f_make'),
            model: v('f_model'),
            serial: v('f_serial'),
            quantity: "1",
            tagType: v('f_tag_type'),
            tagLoc: v('f_tag_loc'),
            project: v('f_project'),
            email: v('f_email'),
            dept: v('f_dept'),
            responsible: v('f_responsible'),
            datetime: timestamp,
            geo: v('f_geo'),
            remarks: v('f_remarks'),
            
            // Files stored as Blobs
            imgBarcode: barcodeFile || null,
            imgSerial: serialFile || null,
            imgAsset: assetFile || null,
            
            // Generate COMPLETELY UNIQUE filenames
            fNameBarcode: barcodeFile ? generateUniqueName('Bar', assetId) : "",
            fNameSerial: serialFile ? generateUniqueName('Ser', assetId) : "",
            fNameAsset: assetFile ? generateUniqueName('Ast', assetId) : ""
        };

        const tx = db.transaction(STORE_DATA, "readwrite");
        tx.objectStore(STORE_DATA).add(entry);
        tx.oncomplete = () => {
            document.getElementById('loading-overlay').style.display = 'none';
            alert("Entry Saved Successfully!");
            updateCount();
            resetForm();
        };
        tx.onerror = () => {
            document.getElementById('loading-overlay').style.display = 'none';
            alert("Error saving data.");
        };
    }

    function resetForm() {
        document.querySelectorAll("input, textarea").forEach(el => el.value = "");
        document.querySelectorAll("select").forEach(el => el.selectedIndex = 0);
        document.getElementById('f_qty').value = "1";
        document.getElementById('f_tagging').value = "YES";
        document.getElementById('f_tag_type').value = "Barcode";
        
        // Hide Images
        document.getElementById('prev_barcode').style.display = 'none';
        document.getElementById('prev_serial').style.display = 'none';
        document.getElementById('prev_asset').style.display = 'none';
        
        // Reset Sub Loc
        updateSubLocations();
    }

    function updateCount() {
        db.transaction(STORE_DATA).objectStore(STORE_DATA).count().onsuccess = e => {
            document.getElementById('db-count').innerText = e.target.result;
        };
    }

    // --- 8. EXPORT ZIP ---
    function exportData() {
        document.getElementById('loading-overlay').style.display = 'flex';
        document.getElementById('loading-text').innerText = "Generating ZIP...";

        const tx = db.transaction(STORE_DATA, "readonly");
        const store = tx.objectStore(STORE_DATA);
        
        store.getAll().onsuccess = async (e) => {
            const data = e.target.result;
            if (data.length === 0) {
                document.getElementById('loading-overlay').style.display = 'none';
                return alert("No data to export.");
            }

            const zip = new JSZip();
            
            // ONE SINGLE FOLDER FOR PHOTOS
            const imgFolder = zip.folder("Photos");

            // CSV Header
            let csv = "Asset ID,Floor,Sub Location,Category,Nature,Description,Tagging,Make,Model,Serial No,Qty,Tag Type,Tag Location,Project,Person/Email,Department,Responsible,Date Time,Geo Code,Remarks,Barcode Photo Name,Serial Photo Name,Asset Photo Name\n";

            data.forEach(item => {
                // Prepare Paths for CSV: Photos/FileName.jpg
                const pathBar = item.fNameBarcode ? `Photos/${item.fNameBarcode}` : "";
                const pathSer = item.fNameSerial ? `Photos/${item.fNameSerial}` : "";
                const pathAst = item.fNameAsset ? `Photos/${item.fNameAsset}` : "";

                // Add CSV Row
                const row = [
                    item.assetId, item.floor, item.subLoc, item.category, item.nature, item.desc, item.tagging,
                    item.make, item.model, item.serial, item.quantity, item.tagType, item.tagLoc, item.project,
                    item.email, item.dept, item.responsible, item.datetime, item.geo, item.remarks,
                    pathBar, pathSer, pathAst
                ].map(f => `"${String(f).replace(/"/g, '""')}"`).join(","); 
                csv += row + "\n";

                // Add Images to the 'Photos' folder
                if(item.imgBarcode) imgFolder.file(item.fNameBarcode, item.imgBarcode);
                if(item.imgSerial) imgFolder.file(item.fNameSerial, item.imgSerial);
                if(item.imgAsset) imgFolder.file(item.fNameAsset, item.imgAsset);
            });

            zip.file("Master_Asset_List.csv", csv);

            // Generate
            const content = await zip.generateAsync({type:"blob"});
            const url = URL.createObjectURL(content);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Asset_Audit_${Date.now()}.zip`;
            a.click();
            
            document.getElementById('loading-overlay').style.display = 'none';
        };
    }

    function clearDB() {
        if(confirm("DANGER: This will delete ALL entries and photos. Are you sure?")) {
            const req = indexedDB.deleteDatabase(DB_NAME);
            req.onsuccess = () => location.reload();
        }
    }
</script>
</body>
</html>