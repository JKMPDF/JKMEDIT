<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Asset Master</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --primary: #007aff; --bg: #f4f4f4; --white: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        
        .card { background: var(--white); border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        h2 { margin: 0 0 10px 0; font-size: 18px; text-align: center; color: #333; }
        label { font-size: 12px; font-weight: bold; color: #666; display: block; margin-top: 10px; text-transform: uppercase; }
        
        /* Inputs & Selects */
        input[type="text"], select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        /* Buttons */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: #28cd41; color: white; }
        .btn-red { background: #ff3b30; color: white; margin-top: 5px; }

        /* Camera & File Inputs */
        #qr-reader { width: 100%; border-radius: 10px; overflow: hidden; background: #000; display: none; margin-bottom: 10px; }
        
        .photo-upload-container { display: flex; gap: 10px; margin-top: 10px; }
        .photo-box { flex: 1; text-align: center; }
        
        /* Hidden file input, styled label acts as button */
        .custom-file-upload {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px dashed #ccc; border-radius: 8px; padding: 10px;
            background: #fafafa; height: 80px; cursor: pointer;
        }
        .custom-file-upload img { max-height: 60px; max-width: 100%; display: none; border-radius: 4px; }
        .custom-file-upload span { font-size: 12px; color: #007aff; margin-top: 5px; }

        /* Table */
        .data-list { font-size: 12px; width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-list td { padding: 8px; border-bottom: 1px solid #eee; background: white; }
        .status-msg { text-align: center; color: green; font-weight: bold; height: 20px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>Asset Entry</h2>
        
        <div id="qr-reader"></div>
        <button id="scan-btn" onclick="startScanner()" class="btn btn-blue">Start QR Scan</button>
        
        <label>Asset ID (from QR)</label>
        <input type="text" id="asset-id" placeholder="Scan or type..." readonly style="background:#eef;">

        <label>Category</label>
        <div style="display:flex; gap:5px;">
            <select id="category"><option value="">Select Category...</option></select>
            <button onclick="addCategory()" style="width:50px; border:1px solid #ddd; border-radius:8px; font-weight:bold;">+</button>
        </div>

        <label>Photos (High Quality)</label>
        <div class="photo-upload-container">
            <div class="photo-box">
                <label for="file-asset" class="custom-file-upload" id="lbl-asset">
                    <span id="txt-asset">ðŸ“¸ Asset Photo</span>
                    <img id="prev-asset">
                </label>
                <input type="file" id="file-asset" accept="image/*" capture="environment" style="display:none" onchange="previewImage(this, 'prev-asset', 'txt-asset')">
            </div>

            <div class="photo-box">
                <label for="file-qr" class="custom-file-upload" id="lbl-qr">
                    <span id="txt-qr">ðŸ“¸ Label Photo</span>
                    <img id="prev-qr">
                </label>
                <input type="file" id="file-qr" accept="image/*" capture="environment" style="display:none" onchange="previewImage(this, 'prev-qr', 'txt-qr')">
            </div>
        </div>

        <button onclick="saveEntry()" class="btn btn-green">Save Entry</button>
        <div id="msg" class="status-msg"></div>
    </div>

    <div class="card">
        <h2>Database (<span id="count">0</span> items)</h2>
        <button onclick="downloadZip()" class="btn" style="background:#333; color:white;">Download ZIP (Excel + Folders)</button>
        <button onclick="clearDatabase()" class="btn btn-red" style="font-size:12px; padding:10px;">Reset System</button>
        <div style="max-height: 200px; overflow-y: auto; margin-top:10px;">
            <table class="data-list" id="entry-table"></table>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const DB_NAME = "ProAssetDB_v1";
    const STORE_NAME = "assets";
    const CAT_STORE = "categories";
    
    let db;
    let html5QrCode;

    // --- 1. INITIALIZE DATABASE (IndexedDB) ---
    // This allows storing 1000+ images without crashing the browser
    const request = indexedDB.open(DB_NAME, 1);
    
    request.onupgradeneeded = (event) => {
        db = event.target.result;
        db.createObjectStore(STORE_NAME, { keyPath: "id" });
        db.createObjectStore(CAT_STORE, { keyPath: "name" });
    };

    request.onsuccess = (event) => {
        db = event.target.result;
        loadCategories();
        updateTable();
    };

    // --- 2. QR CODE LOGIC ---
    function startScanner() {
        document.getElementById('qr-reader').style.display = "block";
        document.getElementById('scan-btn').style.display = "none";
        
        html5QrCode = new Html5Qrcode("qr-reader");
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            onScanFailure
        );
    }

    function onScanSuccess(decodedText, decodedResult) {
        // 1. Alert User
        alert("QR Code Scanned Successfully!\nID: " + decodedText);
        
        // 2. Fill Data
        document.getElementById('asset-id').value = decodedText;
        
        // 3. Stop Camera Immediately
        html5QrCode.stop().then(() => {
            document.getElementById('qr-reader').style.display = "none";
            document.getElementById('scan-btn').style.display = "block";
            document.getElementById('scan-btn').innerText = "Rescan QR";
        });
    }

    function onScanFailure(error) {
        // no-op to keep console clean
    }

    // --- 3. PHOTO HANDLING (Native Camera) ---
    function previewImage(input, imgId, textId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(imgId);
                img.src = e.target.result;
                img.style.display = "block";
                document.getElementById(textId).style.display = "none";
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 4. SAVE LOGIC ---
    function saveEntry() {
        const id = document.getElementById('asset-id').value;
        const cat = document.getElementById('category').value;
        const fileAsset = document.getElementById('file-asset').files[0];
        const fileQr = document.getElementById('file-qr').files[0];

        if (!id || !cat) return alert("Please Scan QR and select Category.");
        if (!fileAsset || !fileQr) return alert("Please take BOTH photos.");

        // Create short filenames
        const ext = fileAsset.name.split('.').pop() || 'jpg';
        const assetName = `AST_${id}.${ext}`;
        const qrName = `LBL_${id}.${ext}`;

        const entry = {
            id: id,
            category: cat,
            timestamp: new Date().toLocaleString(),
            assetBlob: fileAsset, // Store the raw file (efficient)
            qrBlob: fileQr,       // Store the raw file
            assetFileName: assetName,
            qrFileName: qrName
        };

        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).put(entry);
        
        tx.oncomplete = () => {
            document.getElementById('msg').innerText = "Saved: " + id;
            setTimeout(() => document.getElementById('msg').innerText = "", 2000);
            resetForm();
            updateTable();
        };
        
        tx.onerror = () => alert("Error saving. ID might be duplicate.");
    }

    function resetForm() {
        document.getElementById('asset-id').value = "";
        document.getElementById('file-asset').value = "";
        document.getElementById('file-qr').value = "";
        document.getElementById('prev-asset').style.display = "none";
        document.getElementById('prev-qr').style.display = "none";
        document.getElementById('txt-asset').style.display = "block";
        document.getElementById('txt-qr').style.display = "block";
        document.getElementById('scan-btn').innerText = "Start QR Scan";
    }

    // --- 5. CATEGORIES ---
    function addCategory() {
        const name = prompt("Enter new category name:");
        if (name) {
            const tx = db.transaction(CAT_STORE, "readwrite");
            tx.objectStore(CAT_STORE).put({ name: name });
            tx.oncomplete = loadCategories;
        }
    }

    function loadCategories() {
        const select = document.getElementById('category');
        select.innerHTML = '<option value="">Select Category...</option>';
        db.transaction(CAT_STORE).objectStore(CAT_STORE).getAll().onsuccess = (e) => {
            e.target.result.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.name;
                opt.innerText = c.name;
                select.appendChild(opt);
            });
        };
    }

    // --- 6. EXPORT / DOWNLOAD ZIP ---
    async function downloadZip() {
        const zip = new JSZip();
        const assetFolder = zip.folder("Asset_Photos");
        const labelFolder = zip.folder("Label_Photos");
        
        let csvContent = "Asset ID,Category,Date,Asset Photo Name,Label Photo Name\n";
        
        // Get all data
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        
        store.getAll().onsuccess = async (event) => {
            const records = event.target.result;
            if(records.length === 0) return alert("No data to download.");

            document.getElementById('msg').innerText = "Generating ZIP... Please wait.";

            records.forEach(rec => {
                // Add to CSV (Short names only)
                csvContent += `${rec.id},${rec.category},"${rec.timestamp}",${rec.assetFileName},${rec.qrFileName}\n`;
                
                // Add Blobs to Zip Folders
                assetFolder.file(rec.assetFileName, rec.assetBlob);
                labelFolder.file(rec.qrFileName, rec.qrBlob);
            });

            zip.file("Master_Inventory.csv", csvContent);
            
            const content = await zip.generateAsync({type:"blob"});
            const url = URL.createObjectURL(content);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Inventory_Backup_${Date.now()}.zip`;
            a.click();
            document.getElementById('msg').innerText = "Download Started!";
        };
    }

    // --- 7. UI UTILS ---
    function updateTable() {
        const tbody = document.getElementById('entry-table');
        tbody.innerHTML = "";
        
        db.transaction(STORE_NAME).objectStore(STORE_NAME).getAll().onsuccess = (e) => {
            const data = e.target.result;
            document.getElementById('count').innerText = data.length;
            
            // Show last 10 entries only for performance
            data.slice(-10).reverse().forEach(item => {
                const row = `<tr>
                    <td><b>${item.id}</b><br><span style="color:#666">${item.category}</span></td>
                    <td style="text-align:right;">Saved</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        };
    }

    function clearDatabase() {
        if(confirm("DANGER: This will delete all scanned data permanently. Continue?")) {
            const req = indexedDB.deleteDatabase(DB_NAME);
            req.onsuccess = () => location.reload();
        }
    }
</script>
</body>
</html>