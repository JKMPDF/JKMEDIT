<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevMode Pro: Smart Fix</title>
    <style>
        /* --- 1. PROFESSIONAL THEME --- */
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --bg-header: #333333;
            --border: #3e3e42;
            --accent: #007acc;
            --accent-hover: #0062a3;
            --text-main: #cccccc;
            --text-white: #ffffff;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-dark); color: var(--text-main); overflow: hidden; }

        .app-container { display: flex; flex-direction: column; height: 100vh; width: 100vw; }

        /* --- 2. TOOLBAR --- */
        .toolbar {
            height: 45px; background: var(--bg-header); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .brand { font-weight: 600; color: var(--text-white); font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--accent); }

        .device-group { display: flex; background: #252526; padding: 3px; border-radius: 6px; border: 1px solid var(--border); }
        .device-btn {
            background: transparent; border: none; color: #858585; padding: 6px 15px; font-size: 12px; cursor: pointer; border-radius: 4px; transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .device-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .device-btn.active { background: var(--bg-header); color: var(--text-white); box-shadow: 0 1px 4px rgba(0,0,0,0.2); }

        .actions { display: flex; gap: 10px; }
        .btn { padding: 6px 16px; font-size: 12px; border-radius: 4px; cursor: pointer; border: 1px solid transparent; color: white; font-weight: 500; }
        .btn-primary { background: var(--accent); }
        .btn-sec { background: #3c3c3c; border: 1px solid var(--border); }

        /* --- 3. WORKSPACE --- */
        .workspace { flex: 1; display: flex; overflow: hidden; background: #121212; position: relative; }

        .preview-canvas {
            flex: 1; display: flex; justify-content: center; align-items: flex-start;
            padding: 40px; overflow-y: auto;
            background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;
        }

        .device-frame {
            background: white; transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); overflow: hidden; position: relative;
        }
        .device-frame.desktop { width: 100%; height: 100%; border-radius: 4px; border: 1px solid #444; }
        .device-frame.tablet { width: 768px; height: 1024px; border-radius: 12px; border: 12px solid #252526; flex-shrink: 0; }
        .device-frame.mobile { width: 375px; height: 812px; border-radius: 24px; border: 12px solid #252526; border-bottom-width: 30px; flex-shrink: 0; }

        iframe { width: 100%; height: 100%; border: none; background: white; display: block; }

        /* --- 4. POPUP EDITOR --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }

        .editor-popup {
            width: 700px; height: 500px; background: var(--bg-dark); border: 1px solid var(--accent);
            box-shadow: 0 25px 50px rgba(0,0,0,0.8); border-radius: 6px; display: flex; flex-direction: column;
        }

        .popup-header { height: 35px; background: #252526; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
        .popup-title { font-size: 12px; font-weight: bold; color: white; text-transform: uppercase; }
        .close-icon { cursor: pointer; color: #888; font-size: 16px; }
        .close-icon:hover { color: white; }

        .popup-tabs { display: flex; background: #1e1e1e; border-bottom: 1px solid var(--border); }
        .tab { padding: 8px 20px; font-size: 12px; color: #888; cursor: pointer; border-right: 1px solid var(--border); background: #252526; }
        .tab.active { color: var(--accent); background: #1e1e1e; border-top: 2px solid var(--accent); }

        .popup-content { flex: 1; position: relative; }
        textarea.code-editor {
            width: 100%; height: 100%; background: #1e1e1e; color: #d4d4d4; border: none; padding: 15px;
            font-family: 'Consolas', monospace; font-size: 13px; resize: none; outline: none; box-sizing: border-box;
        }

        .popup-footer { padding: 10px 15px; background: #252526; border-top: 1px solid var(--border); text-align: right; }

        /* --- 5. STARTUP OVERLAY --- */
        .startup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1e1e1e; z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .startup-box { width: 500px; background: #252526; padding: 30px; border-radius: 8px; border: 1px solid var(--border); }
        .startup-box textarea { width: 100%; height: 150px; background: #1e1e1e; border: 1px solid var(--border); color: white; margin: 15px 0; padding: 10px; font-family: monospace; }
        
        /* Toast */
        .toast {
            position: fixed; bottom: 20px; right: 20px; background: var(--accent); color: white;
            padding: 10px 20px; border-radius: 4px; font-size: 13px; opacity: 0; transition: 0.3s; z-index: 3000; pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="startup-overlay" id="startupModal">
        <div class="startup-box">
            <h2 style="margin:0 0 10px 0; color:white;">DevMode Pro v3.0</h2>
            <p style="color:#888; font-size:13px;">Paste your code. The smart engine will now fix "DOM Mismatch" errors.</p>
            <textarea id="sourceInput" placeholder="Paste HTML..."></textarea>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-sec" onclick="loadDemo()">Load Demo</button>
                <button class="btn btn-primary" onclick="loadSource()">Start Editor</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <div class="toolbar">
            <div class="brand"><span>âš¡</span> DEVMODE PRO</div>
            <div class="device-group">
                <button class="device-btn" onclick="setDevice('mobile')"><span>ðŸ“±</span> Mobile</button>
                <button class="device-btn" onclick="setDevice('tablet')"><span>ðŸ’Š</span> Tablet</button>
                <button class="device-btn active" onclick="setDevice('desktop')"><span>ðŸ’»</span> Desktop</button>
            </div>
            <div class="actions">
                <button class="btn btn-sec" onclick="downloadCode()">Download Code</button>
            </div>
        </div>

        <div class="workspace">
            <div class="preview-canvas">
                <div class="device-frame desktop" id="deviceFrame">
                    <iframe id="previewFrame"></iframe>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editorModal">
        <div class="editor-popup">
            <div class="popup-header">
                <div class="popup-title" id="popupTitle">EDITING</div>
                <div class="close-icon" onclick="closePopup()">âœ•</div>
            </div>
            <div class="popup-tabs">
                <div class="tab active" onclick="switchTab('html')">HTML</div>
                <div class="tab" onclick="switchTab('css')">CSS</div>
                <div class="tab" onclick="switchTab('js')">JS</div>
            </div>
            <div class="popup-content">
                <textarea class="code-editor" id="editorArea"></textarea>
            </div>
            <div class="popup-footer">
                <button class="btn btn-primary" onclick="applyChanges()">Apply Changes</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Changes Applied!</div>

<script>
    // --- ADVANCED STATE MANAGEMENT ---
    let FULL_SOURCE = "";
    let currentTab = 'html';
    // We store the *exact string* found in the source, not the browser DOM
    let matchedSourceCode = ""; 
    let currentData = null;
    let snippets = { html: "", css: "", js: "" };

    // --- 1. STARTUP ---
    function loadSource() {
        const input = document.getElementById('sourceInput').value;
        if (!input.trim()) return alert("Please paste some code.");
        FULL_SOURCE = input;
        document.getElementById('startupModal').style.display = 'none';
        renderPreview();
    }

    function loadDemo() {
        FULL_SOURCE = `<!DOCTYPE html>
<html>
<style>
    body { font-family: sans-serif; background: #eee; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
    .box { background: white; padding: 40px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    h1 { color: #333; }
    button { background: #007acc; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
</style>
<body>
    <div class="box" id="mainBox">
        <h1>Hello World</h1>
        <p>Click me to test the new Smart Engine!</p>
        <button id="btn" onclick="alert('Works!')">Click Me</button>
    </div>
</body>
</html>`;
        document.getElementById('startupModal').style.display = 'none';
        renderPreview();
    }

    // --- 2. RENDERER & INSPECTOR ---
    function renderPreview() {
        const frame = document.getElementById('previewFrame');
        
        // This script runs inside the iframe to detect clicks
        const inspectorScript = `
            <script>
                let hovered = null;
                const label = document.createElement('div');
                label.style.cssText = "position:fixed;background:#007acc;color:white;padding:3px 6px;font-size:11px;border-radius:3px;pointer-events:none;z-index:9999;display:none;font-family:sans-serif;";
                document.body.appendChild(label);

                document.addEventListener('mouseover', (e) => {
                    e.stopPropagation();
                    if(e.target.tagName === 'BODY' || e.target.tagName === 'HTML') return;
                    if(hovered) hovered.style.outline = '';
                    hovered = e.target;
                    hovered.style.outline = '2px solid #007acc';
                    
                    const rect = hovered.getBoundingClientRect();
                    label.style.display = 'block';
                    label.style.top = (rect.top - 25) + 'px';
                    label.style.left = rect.left + 'px';
                    label.innerText = '<' + hovered.tagName.toLowerCase() + '>';
                });

                document.addEventListener('mouseout', (e) => {
                    if(hovered) hovered.style.outline = '';
                    label.style.display = 'none';
                });

                document.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    window.parent.postMessage({
                        type: 'OPEN_EDITOR',
                        tag: e.target.tagName,
                        id: e.target.id,
                        class: e.target.className,
                        // We send outerHTML just as a fallback/reference
                        browserHTML: e.target.outerHTML
                    }, '*');
                });
            <\/script>
        `;

        const blob = new Blob([FULL_SOURCE + inspectorScript], { type: 'text/html' });
        frame.src = URL.createObjectURL(blob);
    }

    // --- 3. SMART SEARCH ENGINE (The Fix) ---
    window.addEventListener('message', (event) => {
        if(event.data.type === 'OPEN_EDITOR') openPopup(event.data);
    });

    function findInSource(tag, id, cls, browserHTML) {
        // STRATEGY 1: ID Search (Most Accurate)
        if (id) {
            // Regex: <tagName ... id="theID" ... >
            const idRegex = new RegExp(`<${tag}[^>]*id=["']${id}["'][^>]*>`, 'i');
            const match = FULL_SOURCE.match(idRegex);
            if (match) {
                return locateFullBlock(match.index, tag);
            }
        }

        // STRATEGY 2: Class Search
        if (cls) {
            const firstClass = cls.split(' ')[0];
            const classRegex = new RegExp(`<${tag}[^>]*class=["'][^"']*${firstClass}[^"']*["'][^>]*>`, 'i');
            const match = FULL_SOURCE.match(classRegex);
            if (match) {
                return locateFullBlock(match.index, tag);
            }
        }

        // STRATEGY 3: Exact String fallback (if user formatted code nicely)
        if (FULL_SOURCE.includes(browserHTML)) {
            return browserHTML;
        }

        // If all fails, return Browser HTML (User might get an error if they save, but better than nothing)
        return browserHTML;
    }

    // Helper to find where the tag closes starting from an index
    function locateFullBlock(startIndex, tagName) {
        // This is a simplified parser. It finds the opening tag, then searches for the next </tag>
        // Note: Nested tags of same type might confuse this simple logic, but ID search is robust.
        const endTag = `</${tagName.toLowerCase()}>`;
        const restOfCode = FULL_SOURCE.substring(startIndex);
        const endIndex = restOfCode.toLowerCase().indexOf(endTag);
        
        if (endIndex !== -1) {
            return restOfCode.substring(0, endIndex + endTag.length);
        }
        return null; 
    }

    function openPopup(data) {
        currentData = data;
        const name = data.tag.toLowerCase() + (data.id ? '#'+data.id : '');
        document.getElementById('popupTitle').innerText = `EDITING: ${name}`;

        // CRITICAL STEP: Find the *Real* source code
        const realSource = findInSource(data.tag, data.id, data.class, data.browserHTML);
        
        if (realSource) {
            matchedSourceCode = realSource; // Save this specifically for replacement later
            snippets.html = realSource;
        } else {
            alert("Warning: Could not locate this exact element in source (DOM Mismatch). You can edit, but saving might fail if not unique.");
            matchedSourceCode = data.browserHTML;
            snippets.html = data.browserHTML;
        }

        // CSS & JS Finders
        snippets.css = "/* CSS not detected for this element */";
        if(data.class) {
            const c = data.class.split(' ')[0];
            const m = FULL_SOURCE.match(new RegExp(`\\.${c}\\s*\\{[\\s\\S]*?\\}`, 'g'));
            if(m) snippets.css = m[0];
            else snippets.css = `.${c} {\n  /* New Style */\n}`;
        }

        snippets.js = "// JS specific to this ID not found";
        
        switchTab('html');
        document.getElementById('editorModal').classList.add('active');
    }

    function applyChanges() {
        const newCode = document.getElementById('editorArea').value;
        const oldCode = matchedSourceCode; // Use the one we found in Source, not Browser

        if(currentTab === 'html') {
            if(FULL_SOURCE.includes(oldCode)) {
                FULL_SOURCE = FULL_SOURCE.replace(oldCode, newCode);
                matchedSourceCode = newCode; // Update memory
                showToast("Changes Applied!");
            } else {
                // If ID-based search found it, but exact string replace fails (rare), try loose ID replace
                if(currentData.id) {
                     alert("Exact string match lost. Trying force update via ID...");
                     // Logic to regex replace whole block by ID could go here, but usually above works.
                } else {
                    alert("Error: The source code has changed since you opened this popup. Please close and click again.");
                }
            }
            snippets.html = newCode;
        } 
        else if(currentTab === 'css') {
            if(FULL_SOURCE.includes(oldCode)) {
                FULL_SOURCE = FULL_SOURCE.replace(oldCode, newCode);
            } else {
                FULL_SOURCE = FULL_SOURCE.replace('</style>', `\n${newCode}\n</style>`);
            }
            snippets.css = newCode;
            showToast("Styles Updated!");
        }

        renderPreview();
    }

    // --- UI HELPERS ---
    function closePopup() { document.getElementById('editorModal').classList.remove('active'); }
    
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab')[['html','css','js'].indexOf(tab)].classList.add('active');
        document.getElementById('editorArea').value = snippets[tab];
    }

    function setDevice(mode) {
        document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        const f = document.getElementById('deviceFrame');
        f.className = 'device-frame ' + mode;
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = '1'; t.style.transform = 'translateY(-10px)';
        setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(0)'; }, 2000);
    }

    function downloadCode() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([FULL_SOURCE], {type:'text/html'}));
        a.download = 'devmode_fixed.html';
        a.click();
    }
</script>

</body>
</html>
