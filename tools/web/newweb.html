<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevMode: Advanced Visual Editor</title>
    <style>
        /* --- VS CODE STYLE THEME --- */
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --border: #3e3e42;
            --accent: #007acc;
            --text-main: #d4d4d4;
            --text-muted: #858585;
            --success: #4ec9b0;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-dark); color: var(--text-main); overflow: hidden; }
        
        /* Layout Grid */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* Toolbar */
        .toolbar {
            height: 40px; background: #333333; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid var(--border); justify-content: space-between;
        }
        .brand { font-weight: bold; color: var(--accent); letter-spacing: 1px; }
        
        .btn {
            background: #3c3c3c; color: white; border: 1px solid transparent; 
            padding: 5px 12px; font-size: 12px; cursor: pointer; border-radius: 2px; transition: all 0.2s;
        }
        .btn:hover { background: #505050; }
        .btn-primary { background: var(--accent); }
        .btn-primary:hover { background: #0062a3; }

        /* Main Workspace */
        .workspace { display: flex; flex: 1; overflow: hidden; }
        
        /* Left: Preview */
        .preview-area { flex: 1; position: relative; background: white; transition: all 0.3s; }
        iframe { width: 100%; height: 100%; border: none; display: block; }
        
        /* Right: Editor Panel */
        .editor-panel { 
            width: 40%; background: var(--bg-dark); border-left: 1px solid var(--border); 
            display: flex; flex-direction: column;
            transform: translateX(0); transition: transform 0.3s ease;
        }
        .editor-panel.hidden { display: none; }

        /* Tabs */
        .tabs { display: flex; background: var(--bg-panel); }
        .tab { 
            padding: 10px 20px; font-size: 13px; cursor: pointer; border-right: 1px solid var(--border); 
            color: var(--text-muted); background: var(--bg-panel);
        }
        .tab.active { background: var(--bg-dark); color: white; border-top: 2px solid var(--accent); }
        
        /* Code Areas */
        .code-container { flex: 1; position: relative; }
        textarea {
            width: 100%; height: 100%; background: var(--bg-dark); color: #9cdcfe; 
            border: none; padding: 15px; font-family: 'Consolas', 'Courier New', monospace; 
            font-size: 14px; resize: none; outline: none; box-sizing: border-box; line-height: 1.5;
        }
        
        /* Breadcrumbs (Bottom of Editor) */
        .breadcrumbs { padding: 5px 10px; font-size: 11px; background: var(--accent); color: white; }

        /* Overlay for Upload */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .modal { background: var(--bg-panel); padding: 30px; border-radius: 6px; width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        .modal textarea { height: 200px; border: 1px solid var(--border); margin: 15px 0; background: #1e1e1e; }
    </style>
</head>
<body>

<div class="overlay" id="uploadModal">
    <div class="modal">
        <h3 style="margin-top:0">Import Source Code</h3>
        <p style="color: #aaa; font-size: 13px;">Paste your full HTML file (including &lt;style&gt; and &lt;script&gt;) to begin.</p>
        <textarea id="sourceInput" placeholder="<!DOCTYPE html>..."></textarea>
        <div style="text-align: right;">
            <button class="btn btn-primary" onclick="loadSource()">Start Editing</button>
        </div>
    </div>
</div>

<div class="app-container">
    <div class="toolbar">
        <div class="brand">DEVMODE <span style="font-weight:normal; color:#888;">// VISUAL EDITOR</span></div>
        <div>
            <span id="statusMsg" style="font-size: 12px; color: var(--success); margin-right: 15px; opacity: 0; transition: opacity 0.5s;">Changes Applied!</span>
            <button class="btn" onclick="applyChanges()">⚡ Apply Changes</button>
            <button class="btn btn-primary" onclick="downloadCode()">↓ Download Code</button>
        </div>
    </div>

    <div class="workspace">
        <div class="preview-area">
            <iframe id="previewFrame"></iframe>
        </div>

        <div class="editor-panel" id="editorPanel">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('html')">HTML (Structure)</div>
                <div class="tab" onclick="switchTab('css')">CSS (Style)</div>
                <div class="tab" onclick="switchTab('js')">JS (Logic)</div>
            </div>

            <div class="code-container" id="editorContainer">
                <textarea id="codeEditor"></textarea>
            </div>
            
            <div class="breadcrumbs" id="breadcrumbs">Select an element to edit...</div>
        </div>
    </div>
</div>

<script>
    // --- GLOBAL STATE ---
    let FULL_SOURCE = "";
    let activeElementData = null;
    let currentTab = 'html'; 
    
    // We store the "original snippet" for search-and-replace operations
    let snippets = {
        html: { original: "", start: 0, end: 0 },
        css: { original: "", start: 0, end: 0 },
        js: { original: "", start: 0, end: 0 }
    };

    // --- 1. INITIALIZATION ---
    function loadSource() {
        const input = document.getElementById('sourceInput').value;
        if (!input.trim()) return alert("Please paste code first.");
        
        FULL_SOURCE = input;
        document.getElementById('uploadModal').style.display = 'none';
        renderPreview();
    }

    // --- 2. RENDERER (With Advanced Inspector) ---
    function renderPreview() {
        const frame = document.getElementById('previewFrame');
        
        // The Inspector Script: Injected into the user's code
        const inspectorScript = `
            <script>
                let hoveredEl = null;
                let originalOutline = '';
                let originalCursor = '';

                // 1. Hover Highlighter
                document.addEventListener('mouseover', (e) => {
                    e.stopPropagation();
                    // Don't highlight the body/html to avoid clutter
                    if(e.target.tagName === 'BODY' || e.target.tagName === 'HTML') return;

                    if (hoveredEl) {
                        hoveredEl.style.outline = originalOutline;
                        hoveredEl.style.cursor = originalCursor;
                    }
                    
                    hoveredEl = e.target;
                    originalOutline = hoveredEl.style.outline;
                    originalCursor = hoveredEl.style.cursor;

                    // Visualize
                    hoveredEl.style.outline = '2px solid #007acc';
                    hoveredEl.style.cursor = 'crosshair';
                });

                document.addEventListener('mouseout', (e) => {
                   if(hoveredEl) {
                       hoveredEl.style.outline = originalOutline;
                       hoveredEl.style.cursor = originalCursor;
                   }
                });

                // 2. Click Capture
                document.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const target = e.target;

                    // --- CRITICAL FIX: CLEAN BEFORE CAPTURE ---
                    // 1. Remove the "DevMode" visual styles temporarily
                    target.style.outline = originalOutline;
                    target.style.cursor = originalCursor;
                    
                    // 2. Remove style attribute entirely if it is now empty 
                    // (Browsers leave style="" behind, which breaks matching)
                    const hadStyle = target.getAttribute('style');
                    if (!hadStyle || hadStyle.trim() === '') {
                        target.removeAttribute('style');
                    }

                    // 3. Capture the CLEAN HTML
                    const cleanHTML = target.outerHTML;

                    // 4. Build Path
                    let path = [];
                    let el = target;
                    while (el && el.tagName) {
                        path.unshift(el.tagName.toLowerCase() + (el.id ? '#'+el.id : '') + (el.className ? '.'+el.className.split(' ')[0] : ''));
                        el = el.parentElement;
                    }

                    // 5. Send Data
                    window.parent.postMessage({
                        type: 'ELEMENT_SELECTED',
                        tagName: target.tagName.toLowerCase(),
                        id: target.id,
                        className: target.className,
                        outerHTML: cleanHTML, // This is now clean
                        path: path.join(' > ')
                    }, '*');
                    
                    // 6. Restore Visuals (So user knows what is selected)
                    target.style.outline = '2px solid #007acc';
                    target.style.cursor = 'crosshair';
                }, true);
            <\/script>
        `;
        
        // Inject script
        const blob = new Blob([FULL_SOURCE + inspectorScript], { type: 'text/html' });
        frame.src = URL.createObjectURL(blob);
    }

    // --- 3. EVENT LISTENER ---
    window.addEventListener('message', (event) => {
        if (event.data.type === 'ELEMENT_SELECTED') {
            activeElementData = event.data;
            updateEditorPanel(event.data);
        }
    });

    // --- 4. INTELLIGENT PARSER ---
    function updateEditorPanel(data) {
        document.getElementById('breadcrumbs').innerText = data.path;
        
        // A. FIND HTML
        let cleanHTML = data.outerHTML;
        
        // Attempt to find this block in FULL_SOURCE. 
        // We set this as "original" so we know what to replace later.
        snippets.html.original = cleanHTML; 
        
        // B. FIND CSS
        snippets.css.original = "/* No CSS found for this element */";
        if (data.className) {
            const firstClass = data.className.split(' ')[0];
            // Regex to find .classname { ... }
            const cssRegex = new RegExp(`\\.${firstClass}\\s*\\{[\\s\\S]*?\\}`, "g");
            const match = FULL_SOURCE.match(cssRegex);
            if (match) {
                snippets.css.original = match[0];
            } else {
                snippets.css.original = `/* Create new style */\n.${firstClass} {\n    background-color: #ffffff;\n    color: #000000;\n}`;
            }
        } else if (data.id) {
             const cssRegex = new RegExp(`#${data.id}\\s*\\{[\\s\\S]*?\\}`, "g");
             const match = FULL_SOURCE.match(cssRegex);
             if (match) snippets.css.original = match[0];
        } else {
             const cssRegex = new RegExp(`${data.tagName}\\s*\\{[\\s\\S]*?\\}`, "g");
             const match = FULL_SOURCE.match(cssRegex);
             if (match) snippets.css.original = match[0];
        }

        // C. FIND JS (Look for ID refs)
        snippets.js.original = "// No direct JS references found.";
        if (data.id) {
            // Escape the ID for regex safety
            const safeId = data.id.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            // Look for getElementById('id') OR getElementById("id")
            const jsRegex = new RegExp(`.*getElementById\\(['"]${safeId}['"]\\).*`, "g");
            const match = FULL_SOURCE.match(jsRegex);
            if(match) snippets.js.original = match.join('\n');
        }

        // Load the active tab
        renderTabContent();
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab')[['html','css','js'].indexOf(tabName)].classList.add('active');
        currentTab = tabName;
        renderTabContent();
    }

    function renderTabContent() {
        const editor = document.getElementById('codeEditor');
        if (currentTab === 'html') editor.value = snippets.html.original;
        else if (currentTab === 'css') editor.value = snippets.css.original;
        else if (currentTab === 'js') editor.value = snippets.js.original;
    }

    // --- 5. APPLY LOGIC ---
    function applyChanges() {
        const newCode = document.getElementById('codeEditor').value;
        let oldCode = snippets[currentTab].original;

        // If CSS new style creation
        if (currentTab === 'css' && oldCode.includes("/* No CSS found")) {
            if(FULL_SOURCE.includes('</style>')) {
                FULL_SOURCE = FULL_SOURCE.replace('</style>', `\n${newCode}\n</style>`);
            } else {
                FULL_SOURCE = FULL_SOURCE.replace('</head>', `<style>\n${newCode}\n</style>\n</head>`);
            }
        } 
        // Standard Replacement
        else {
            // 1. Try exact match
            if (FULL_SOURCE.includes(oldCode)) {
                FULL_SOURCE = FULL_SOURCE.replace(oldCode, newCode);
            } 
            // 2. Fallback: Try matching quote variations (Single vs Double)
            else {
                // If the browser normalized <div id='x'> to <div id="x">, we swap quotes to find the match
                const altOldCode = oldCode.includes('"') 
                    ? oldCode.replace(/"/g, "'") 
                    : oldCode.replace(/'/g, '"');

                if (FULL_SOURCE.includes(altOldCode)) {
                    FULL_SOURCE = FULL_SOURCE.replace(altOldCode, newCode);
                } else {
                    console.log("Failed to find:", oldCode);
                    alert("Exact match lost.\n\nReason: The browser reformatted the HTML (e.g., changed ' to \").\n\nTip: Try editing a smaller portion of text or adding a unique ID to the element.");
                    return;
                }
            }
        }

        // Update the 'original' memory
        snippets[currentTab].original = newCode;

        // Visual Feedback
        const status = document.getElementById('statusMsg');
        status.style.opacity = '1';
        setTimeout(() => status.style.opacity = '0', 2000);

        renderPreview();
    }

    function downloadCode() {
        const blob = new Blob([FULL_SOURCE], {type: "text/html"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "advanced_edit.html";
        a.click();
    }
</script>

</body>
</html>
